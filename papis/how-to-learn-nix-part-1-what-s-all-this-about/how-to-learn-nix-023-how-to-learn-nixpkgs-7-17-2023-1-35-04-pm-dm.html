<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/ 
 saved date: Mon Jul 17 2023 13:35:04 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 23: How to learn Nixpkgs</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"üåñ"}#dmt:hover::before{content:"üåó"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"üåí"}:root:not(.light-theme) #dmt:hover::before{content:"üåì"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}sup{font-size:75%}sup a::before{content:"["}sup a::after{content:"]"}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}.footnotes>ol{margin-top:1em}.footnotes li:not(.highlight){transition:background-color 1s}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}a.footnote-ref:visited,a.footnote-backref:visited,.notation-help-link-container a:visited{color:var(--link)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+section,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight,main div.highlight+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cm{color:var(--palette-dim)}.highlight .c1{color:var(--palette-dim)}.highlight .kn{color:var(--palette-teal)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .ne{color:var(--palette-red)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 23: How to learn Nixpkgs">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>
<meta name=description content="Well, I took a bit of a break from learning Nix, but I‚Äôm back to continue my journey through the documentation.
I already read the whole Nix manual, so now it‚Äôs time read through the Nixpkgs manual. Wish me luck.">
<meta property=og:description content="Well, I took a bit of a break from learning Nix, but I‚Äôm back to continue my journey through the documentation.
I already read the whole Nix manual, so now it‚Äôs time read through the Nixpkgs manual. Wish me luck.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-03-31>March 31, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to Learn Nix, Part&nbsp;23:<br>How to learn Nixpkgs</a></h1>
</div>
<div class=post-content><p>Well, I took a bit of a break from learning Nix, but I‚Äôm back to continue my journey through the documentation.</p>
<p>I already read the whole Nix manual, so now it‚Äôs time read through <a href=https://web.archive.org/web/20210318102415/https://nixos.org/manual/nixpkgs/stable/>the Nixpkgs manual</a>. Wish me luck.</p>
<h1 id=chapter-1-prefacehttpswebarchiveorgweb20210318102415httpsnixosorgmanualnixpkgsstablepreface><a href=https://web.archive.org/web/20210318102415/https://nixos.org/manual/nixpkgs/stable/#preface>Chapter 1: Preface</a></h1>
<blockquote>
<p>This manual primarily describes how to write packages for the Nix Packages collection (Nixpkgs). Thus it‚Äôs mainly for packagers and developers who want to add packages to Nixpkgs.</p>
</blockquote>
<p>Hmm. At this point in my life I don‚Äôt really want to contribute to Nixpkgs. I was hoping that by reading this manual I would learn something about how to specify, like, <code>opam</code> dependencies or something. How to actually write <code>shell.nix</code> files for nontrivial projects. We shall see if this hope is in vain.</p>
<p>We get a little overview of channels, including the <code>nixpkgs</code> channels vs the <code>nixos</code> channels.</p>
<p>Hmm. The manual describes channels named <code>nixpkgs</code> and <code>nixos-unstable</code>. But the default Nix installation uses a channel called <code>nixpkgs-unstable</code>. I assume this is documentation rot, as the manual‚Äôs description of <code>nixpkgs</code> (that it follows <code>master</code>) seems to match my understanding of <code>nixpkgs-unstable</code>.</p>
<p>I learn the word Hydra, which was a word <a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>I already remembered</a>, and learn that it produces builds for <code>x86_64-linux</code>, <code>i686-linux</code> and <code>x86_64-darwin</code>. What about the new ‚ÄúM1‚Äù Macs? I guess they aren‚Äôt cached yet.</p>
<h1 id=chapter-2-global-configurationhttpswebarchiveorgweb20210318102415httpsnixosorgmanualnixpkgsstablechap-packageconfig><a href=https://web.archive.org/web/20210318102415/https://nixos.org/manual/nixpkgs/stable/#chap-packageconfig>Chapter 2. Global configuration</a></h1>
<p>I learn various reasons that Nix will refuse to install packages. It lists a few reasons:</p>
<p>First off, if <code>meta.broken = true</code>. It doesn‚Äôt say anything about <em>why</em> this would be the case. Is this intended for like‚Ä¶ package maintainers to easily mark the latest release as broken? Is this something Nix will override with a mechanism like the <code>nix-env --set-flag</code> thing? What‚Äôs the point of this?</p>
<p>The next two reasons make sense: if a package is not supported on the current platform, or if it has an unfree license ‚Äì I encountered the latter already.</p>
<p>The last reason is if there are any <code>meta.knownVulnerabilities</code>. Why is this different from <code>broken</code>? Just better signaling? I don‚Äôt know.</p>
<p>Then we learn something fascinating:</p>
<blockquote>
<p>Note that all this is checked during evaluation already, and the check includes any package that is evaluated. In particular, all build-time dependencies are checked. <code>nix-env -qa</code> will (attempt to) hide any packages that would be refused.</p>
</blockquote>
<p>Innnnteresting. So <code>nix-env -qa</code> is not actually printing all the derivations it can find in an expression, as I thought I learned previously. It‚Äôs actually filtering things out. Let‚Äôs see it:</p>
<pre tabindex=0><code>$ cat packages.nix
with import &lt;nixpkgs&gt; {}; [
  git
  hello
]

$ nix-env -qa --file packages.nix
git-2.30.1
hello-2.10
</code></pre><p>But if I break a package‚Ä¶</p>
<pre tabindex=0><code>$ cat packages.nix
with import &lt;nixpkgs&gt; {}; [
  (hello // { meta.broken = true; }) git
]

$ nix-env -qa --file packages.nix
git-2.30.1
hello-2.10
</code></pre><p>Nope. Doesn‚Äôt‚Ä¶ doesn‚Äôt work. Why not? Because <code>// { meta.broken = true; }</code> didn‚Äôt do the thing I expected it to do? Because it doesn‚Äôt actually filter broken packages? I don‚Äôt know.</p>
<pre tabindex=0><code>$ cat packages.nix
with import &lt;nixpkgs&gt; {}; [
  git
  (hello // { name = "something"; })
]

$ nix-env -qa --file packages.nix
git-2.30.1
something
</code></pre><p>Well, hmm. It does seem like it‚Äôs doing <em>something</em>.</p>
<pre tabindex=0><code>$ cat packages.nix
with import &lt;nixpkgs&gt; {}; [
  git
  (hello // { meta.knownVulnerabilities = ["something bad"]; })
]

$ nix-env -qa --file packages.nix
git-2.30.1
hello-2.10
</code></pre><p>But not this. I have no idea. It seems like <code>nix-env -qa</code> is not actually doing the filtering that the manual describes, or I have no idea what I‚Äôm doing. Which is‚Ä¶ plausible.</p>
<p>Moving on, we learn about the Nixpkgs configuration. I have <a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>already configured Nixpkgs to allow me to install unfree programs</a>, and the manual doesn‚Äôt say anything about any other configuration option.</p>
<p>This is a curious note:</p>
<blockquote>
<p>Note that we are not able to test or build unfree software on Hydra due to policy. Most unfree licenses prohibit us from either executing or distributing the software.</p>
</blockquote>
<p>Huh. I have definitely installed ‚Äúunfree‚Äù packages, and I <em>thought</em> I was installing them from the binary cache. But apparently not:</p>
<pre tabindex=0><code>$ nix-env -qasA nixpkgs.keen4
---  keen4

$ nix-env -qasA nixpkgs.ngrok
IP-  ngrok-2.3.35
</code></pre><p>I suspect that I didn‚Äôt notice that I was ‚Äúbuilding‚Äù these myself because they are just set up to download binary distributions from somewhere else. But I don‚Äôt know how to view the derivation description.</p>
<p>I tried:</p>
<pre><code>$ nix-env -qaA nixpkgs.ngrok --json
</code></pre>
<p>But that just prints out, like, the name and <code>meta</code> fields and stuff. Nothing about the actual Nix expression or <code>builder</code> or anything interesting.</p>
<p>How do I see that? Previously I have just been <code>rg</code>ing through the Nixpkgs tree, but there‚Äôs <em>gotta</em> be a better way to do it. But I don‚Äôt know how yet, so I eventually find:</p>
<pre><code>$ cat ~/src/nixpkgs/pkgs/tools/networking/ngrok-2/default.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>lib</span><span class=o>,</span> <span class=n>stdenv</span><span class=o>,</span> <span class=n>fetchurl</span> <span class=p>}:</span>

<span class=k>with</span> <span class=n>lib</span><span class=p>;</span>

<span class=k>let</span> <span class=n>versions</span> <span class=o>=</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>fromJSON</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>readFile</span> <span class=sr>./versions.json</span><span class=p>);</span>
    <span class=n>arch</span> <span class=o>=</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isi686</span> <span class=k>then</span> <span class=s2>"386"</span>
           <span class=k>else</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isx86_64</span> <span class=k>then</span> <span class=s2>"amd64"</span>
           <span class=k>else</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isAarch32</span> <span class=k>then</span> <span class=s2>"arm"</span>
           <span class=k>else</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isAarch64</span> <span class=k>then</span> <span class=s2>"arm64"</span>
           <span class=k>else</span> <span class=ne>throw</span> <span class=s2>"Unsupported architecture"</span><span class=p>;</span>
    <span class=n>os</span> <span class=o>=</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isLinux</span> <span class=k>then</span> <span class=s2>"linux"</span>
         <span class=k>else</span> <span class=k>if</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isDarwin</span> <span class=k>then</span> <span class=s2>"darwin"</span>
         <span class=k>else</span> <span class=ne>throw</span> <span class=s2>"Unsupported os"</span><span class=p>;</span>
    <span class=n>versionInfo</span> <span class=o>=</span> <span class=n>versions</span><span class=o>.</span><span class=s2>"</span><span class=si>${</span><span class=n>os</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=n>arch</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=k>inherit</span> <span class=p>(</span><span class=n>versionInfo</span><span class=p>)</span> <span class=n>version</span> <span class=n>sha256</span> <span class=n>url</span><span class=p>;</span>

<span class=k>in</span>
<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"ngrok-</span><span class=si>${</span><span class=n>version</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
  <span class=n>version</span> <span class=o>=</span> <span class=n>version</span><span class=p>;</span>

  <span class=c1># run ./update</span>
  <span class=n>src</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span> <span class=k>inherit</span> <span class=n>sha256</span> <span class=n>url</span><span class=p>;</span> <span class=p>};</span>

  <span class=n>sourceRoot</span> <span class=o>=</span> <span class=s2>"."</span><span class=p>;</span>

  <span class=n>unpackPhase</span> <span class=o>=</span> <span class=s2>"cp $src ngrok"</span><span class=p>;</span>

  <span class=n>buildPhase</span> <span class=o>=</span> <span class=s2>"chmod a+x ngrok"</span><span class=p>;</span>

  <span class=n>installPhase</span> <span class=o>=</span> <span class=s1>''
</span><span class=s1>    install -D ngrok $out/bin/ngrok
</span><span class=s1>  ''</span><span class=p>;</span>

  <span class=n>passthru</span><span class=o>.</span><span class=n>updateScript</span> <span class=o>=</span> <span class=sr>./update.sh</span><span class=p>;</span>

  <span class=n>meta</span> <span class=o>=</span> <span class=p>{</span> <span class=cm>/* ... */</span> <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>And yeah, it seems to just download a literal binary, run <code>chmod a+x</code> it, and then copy it into place ‚Äì consulting a JSON file to find out the particular path to fetch.</p>
<p>I have never seen the <code>install</code> command before. I run <code>man install</code> to see what <code>-D</code> does, but my man page doesn‚Äôt list <code>-D</code> as an option. I realize that I‚Äôm looking at the BSD <code>install</code> that comes with macOS, and Nix is surely providing the GNU version to this script.</p>
<p>Hmm. I try <code>nix-shell -p coreutils</code> and run <code>man install</code> from there, but that doesn‚Äôt work. Is <code>install</code> not in <code>coreutils</code>? Where does it come from? I don‚Äôt know how to answer that. I google it, and find that it <em>is</em> in <code>coreutils</code>. Hmmmmm.</p>
<pre tabindex=0><code>$ nix-shell -p coreutils

[nix-shell:~/scratch]$ man --path | tr ':' '\n' | grep /nix/store
/nix/store/3wwfb12b0d6rvnrybxx5r667kl56z62c-clang-7.1.0/share/man
/nix/store/3nb6lyw2ifs1jcjw3syvmmyin4na7pml-findutils-4.7.0/share/man
/nix/store/dclj3gvqhh5flc29qwc1k3aha7mg68m8-diffutils-3.7/share/man
/nix/store/36gm5gm0z2c4xc9dkkk4lz2xag10ydlz-gnused-4.8/share/man
/nix/store/cgcdla09aph706qq8wc1k58hzhwnqvgd-gnugrep-3.6/share/man
/nix/store/n6rqh41cd83yksyfkc9ly0p6iawqdb7g-gnutar-1.32/share/man
/nix/store/xymy7f6kbyjdvdlp4m6g2ia30fg3d0d4-patch-2.7.6/share/man
</code></pre><p>That‚Äôs just <em>weird</em>, right? Why don‚Äôt I get <code>coreutils</code> in my <code>MANPATH</code>? Well, because I have no <code>MANPATH</code>:</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ echo $MANPATH

</code></pre><p>Hmmm. I thought that Nix was setting that for me. But I guess not.</p>
<p>Then where are those <code>man</code> pages coming from? I‚Äôve honestly never had to think about this before.</p>
<p>My <code>/etc/man.conf</code> is <em>quite large</em>. And no more illuminating.</p>
<p><code>man man</code> tells me that if there is no explicit rule for where to find <code>man</code> pages for executables in a particular directory, it‚Äôs going to ‚Äúsearch nearby directories.‚Äù I <em>assumed</em> that this meant, like, if I have <code>/foo/bar/exe</code> on my path, and I run <code>exe</code>, it would search for like <code>/foo/bar/man</code>, <code>/foo/man</code>, <code>/foo/share</code>, etc.</p>
<p>But apparently it‚Äôs <em>much weirder</em>. It appears to be checking through <em>all elements in my <code>PATH</code></em>. Like, not just where the command is in my <code>PATH</code>. It‚Äôs just looking through every <code>PATH</code> entry I have and checking each of them, just in case.</p>
<p>That‚Äôs‚Ä¶ that‚Äôs messed up. TIL.</p>
<p>Anyway, while (e.g.) <code>findutils</code> has manual entries:</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ ls $(dirname $(which find))/../share/man/man1
find.1.gz  locate.1.gz  updatedb.1.gz  xargs.1.gz
</code></pre><p><code>coreutils</code> does not.</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ ls $(dirname $(which install))/..
bin  libexec
</code></pre><p>Huh. Why is this? I suspect <code>coreutils</code> has a different ‚Äúoutput‚Äù for the man pages.</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ grep outputs ~/src/nixpkgs/pkgs/tools/misc/coreutils/default.nix
  outputs = [ "out" "info" ];
</code></pre><p>Hrmmm. <code>info</code>. Surely I don‚Äôt have to‚Ä¶</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ info install | head -n4
info: Writing node (*manpages*)install...
info: Done.
File: *manpages*,  Node: install,  Up: (dir)


INSTALL(1)                BSD General Commands Manual               INSTALL(1)
</code></pre><p>Nope. Still the macOS version. Well hmm.</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ nix path-info coreutils
error: attribute 'coreutils' in selection path 'coreutils' not found

[nix-shell:~/scratch]$ nix path-info nixpkgs.coreutils
/nix/store/cpvjym13fdglv6zmdr5xav20g5rbafbx-coreutils-8.32
</code></pre><p>Hmm. That‚Äôs the default output. I look through <code>nix path-info --help</code> and can‚Äôt find anything about specifying a different output path. I try <code>nix-path-info --json</code>, which prints a single line of un-prettified JSON. So I have to re-run it piped to <code>jq</code> because, you know, that‚Äôs how the world works. And it still only contains info about the default output path.</p>
<p>So‚Ä¶ hmm. I think‚Ä¶ I remember a <a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>builtin Nix <em>function</em></a> that would give me the output path of a derivation. I never tried it, but maybe that‚Äôs the way to find this?</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ nix repl
Welcome to Nix version 2.3.10. Type :? for help.

nix-repl&gt; builtins.placeholder
¬´primop¬ª

nix-repl&gt; builtins.placeholder "something"
"/0skbjwsyd85bdxhd3x3kvw6wsbnjb3g5l7w373q1kgyhnk76r5i2"

nix-repl&gt; builtins.placeholder "out"
"/1rz4g4znpzjwh1xymhjpm42vipw92pr73vdgl6xs1hycac8kf2n9"
</code></pre><p>Okay that‚Äôs‚Ä¶ clearly I misunderstood that one. That looks more like a weird <code>gensym</code> thing. Alright. I‚Ä¶ I guess <code>grep</code> to the rescue?</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ ls /nix/store | grep coreutils
03abqbaf96ngihm2zlai0pvfnw8a6zx8-bootstrap-stage0-coreutils.drv
4wfhsy75bs6lsw8c3nyxm869z4w5g8vd-coreutils-8.32
5zvff00nbbisd0155mqi5p2a36v19igg-coreutils-8.32.drv
99nsvxbwhdjgk2s4yxm0i7gm4ld0lkpx-coreutils-8.30
cdsg68agqa5mz7k47m6d9g807bqnwqf4-coreutils-8.32.drv
cpvjym13fdglv6zmdr5xav20g5rbafbx-coreutils-8.32
cz505gmkb0qza9mfmrihp5cwj4yi05m1-coreutils-8.32.tar.xz.drv
fri7mcas1zv9gs7dqq0g1fkdffngmm92-coreutils-8.32.drv
h6bjy3wzdz99sv3z0cp54gi7xi5hmyx6-coreutils-8.32.drv
ilzpa1x1wq9hkcz54jcni9lpvwq8inn1-coreutils-8.30.drv
p0w2xz6h0b41vyhw7y3isrfz3g2v4xij-coreutils-8.30.tar.xz.drv
pwksbjpnp3baw1p7r0wdavqq0y77s089-coreutils-8.32.drv
sgrrr36rgw7mijksqvc5vi0z6xhds5d9-coreutils-8.30.drv
x1fbs9sabqz43xar0slgnxf97pyyafh5-coreutils-8.32.drv
</code></pre><p>Well, okay. I don‚Äôt have the <code>info</code> output installed? I guess? So I have all the GNU coreutils, but not their documentation. Super.</p>
<p>How do I‚Ä¶ get that? I try this on a whim:</p>
<pre tabindex=0><code>$ nix-shell -p coreutils.info
these paths will be fetched (0.18 MiB download, 0.91 MiB unpacked):
  /nix/store/gg4347kccwbipad94cw8rh3ynmv8kahz-coreutils-8.32-info
copying path '/nix/store/gg4347kccwbipad94cw8rh3ynmv8kahz-coreutils-8.32-info' from 'https://cache.nixos.org'...
</code></pre><p>And it worked! Why did it work? I don‚Äôt know. I still don‚Äôt understand what a derivation is, or what ‚Äúattributes‚Äù it has, or‚Ä¶ how any of this works.</p>
<p>Anyway, I have the <code>info</code> page, but I have <em>no idea</em> how to get <code>info</code> to actually consult this page.</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ info install -d /nix/store/gg4347kccwbipad94cw8rh3ynmv8kahz-coreutils-8.32-info/share/info
info: dir: No such file or directory

[nix-shell:~/scratch]$ INFOPATH=/nix/store/gg4347kccwbipad94cw8rh3ynmv8kahz-coreutils-8.32-info/share/info info install
(displays the BSD one)
</code></pre><p>???</p>
<p>I don‚Äôt know. Screw it.</p>
<pre tabindex=0><code>[nix-shell:~/scratch]$ info -f /nix/store/gg4347kccwbipad94cw8rh3ynmv8kahz-coreutils-8.32-info/share/info/coreutils.info
</code></pre><p>That works, and after navigating then <code>info</code> UI for a bit ‚Äì why is this‚Ä¶ just why ‚Äì I finally find the documentation for <code>install</code>, which says:</p>
<pre tabindex=0><code>‚Äò-D‚Äô
     Create any missing parent directories of DEST, then copy SOURCE to
     DEST.  Explicitly specifying the ‚Äò--target-directory=DIR‚Äô will
     similarly ensure the presence of that hierarchy before copying
     SOURCE arguments.

‚Äò-d‚Äô
‚Äò--directory‚Äô
     Create any missing parent directories, giving them the default
     attributes.  Then create each given directory, setting their owner,
     group and mode as given on the command line or to the defaults.
</code></pre><p><em>Well wasn‚Äôt that easy</em>.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<p>Alright. That was a horrible detour. All to answer the question of what this little derivation is doing:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"ngrok-</span><span class=si>${</span><span class=n>version</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
  <span class=n>version</span> <span class=o>=</span> <span class=n>version</span><span class=p>;</span>

  <span class=c1># run ./update</span>
  <span class=n>src</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span> <span class=k>inherit</span> <span class=n>sha256</span> <span class=n>url</span><span class=p>;</span> <span class=p>};</span>

  <span class=n>sourceRoot</span> <span class=o>=</span> <span class=s2>"."</span><span class=p>;</span>

  <span class=n>unpackPhase</span> <span class=o>=</span> <span class=s2>"cp $src ngrok"</span><span class=p>;</span>

  <span class=n>buildPhase</span> <span class=o>=</span> <span class=s2>"chmod a+x ngrok"</span><span class=p>;</span>

  <span class=n>installPhase</span> <span class=o>=</span> <span class=s1>''
</span><span class=s1>    install -D ngrok $out/bin/ngrok
</span><span class=s1>  ''</span><span class=p>;</span>

  <span class=n>passthru</span><span class=o>.</span><span class=n>updateScript</span> <span class=o>=</span> <span class=sr>./update.sh</span><span class=p>;</span>

  <span class=n>meta</span> <span class=o>=</span> <span class=p>{</span> <span class=cm>/* ... */</span> <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>And honestly? I still don‚Äôt understand what the difference is between <code>-d</code> and <code>-D</code>. Both seem to be to do the <code>mkdir -p</code> thing. BSD <code>install</code> only has <code>-d</code>. I don‚Äôt know. I learned nothing. It does roughly the thing that I assumed that it did from the very beginning of this.</p>
<p>It seems <em>weird</em> to use <code>install</code> ‚Äì which as far as I can tell exists to copy files while setting owner/group/permission bits to something ‚Äì while <em>also</em> running <code>chmod a+x</code> in the <code>buildPhase</code>. Like‚Ä¶ we could just‚Ä¶ whatever. None of this matters.</p>
<p>So yes, the Nixpkgs manual is telling the truth: we did not get this binary distribution from the official NixOS cache.</p>
<p>Let‚Äôs keep reading.</p>
<p>In the same way that I can <code>allowUnfree</code>, I can also <code>allowBroken</code>, or <code>allowUnsupportedSystem</code>. Okay. I am pleased by this explanation:</p>
<blockquote>
<p>The difference between a package being unsupported on some system and being broken is admittedly a bit fuzzy. If a program <em>ought</em> to work on a certain platform, but doesn‚Äôt, the platform should be included in <code>meta.platforms</code>, but marked as broken with e.g. <code>meta.broken = !hostPlatform.isWindows</code>. Of course, this begs the question of what ‚Äúought‚Äù means exactly. That is left to the package maintainer.</p>
</blockquote>
<p>That gives me some intuition for what <code>broken</code> means, in a very human way. I like that, and I‚Äôm not even going to say anything pretentious about the idiom they employed.</p>
<p>I learn that I can set <code>whitelistedLicenses</code> and <code>blacklistedLicenses</code>, in case I am a lawyer with strong opinions about software licenses.</p>
<p>There is no blanket <code>allowInsecure</code>, but I can whitelist specific packages to install. That‚Äôs nice.</p>
<h1 id=25-modify-packages-via-packageoverrideshttpswebarchiveorgweb20210318102415httpsnixosorgmanualnixpkgsstablesec-modify-via-packageoverrides><a href=https://web.archive.org/web/20210318102415/https://nixos.org/manual/nixpkgs/stable/#sec-modify-via-packageOverrides>2.5. Modify packages via <code>packageOverrides</code></a></h1>
<p><em>Now we‚Äôre talking</em>. This seems really useful. The example given is this:</p>
<blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span> <span class=k>rec</span> <span class=p>{</span>
    <span class=n>foo</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span> <span class=o>...</span> <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div></blockquote>
<p>Which I can use to change derivations on the fly, I guess? What is <code>.override</code>? A <em>method??</em></p>
<p>Unfortunately the example doesn‚Äôt <em>actually</em> tell us how to use it, but it must be intuitive, right? Let‚Äôs see if we can see this in action.</p>
<pre><code>$ cat packages.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=p>[</span>
  <span class=n>git</span>
  <span class=p>(</span><span class=n>hello</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span> <span class=n>meta</span><span class=o>.</span><span class=n>knownVulnerabilities</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"something bad"</span><span class=p>];</span> <span class=p>})</span>
<span class=p>]</span>
</code></pre></div><pre tabindex=0><code>$ nix-env -qa --file packages.nix
error: anonymous function at /nix/store/mi0xpwzl81c7dgpr09qd67knbc24xab5-nixpkgs-21.05pre274251.f5f6dc053b1/nixpkgs/pkgs/applications/misc/hello/default.nix:1:1
called with unexpected argument 'meta', at /nix/store/mi0xpwzl81c7dgpr09qd67knbc24xab5-nixpkgs-21.05pre274251.f5f6dc053b1/nixpkgs/lib/customisation.nix:69:16
</code></pre><p>Okay nope. It seems only specific fields can be overridden. Okay‚Ä¶</p>
<pre><code>$ cat packages.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=p>[</span>
  <span class=n>git</span>
  <span class=p>(</span><span class=n>hello</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span> <span class=n>name</span> <span class=o>=</span> <span class=s2>"goodbye"</span><span class=p>;</span> <span class=p>})</span>
<span class=p>]</span>
</code></pre></div><pre tabindex=0><code>$ nix-env -qa --file packages.nix
error: anonymous function at /nix/store/mi0xpwzl81c7dgpr09qd67knbc24xab5-nixpkgs-21.05pre274251.f5f6dc053b1/nixpkgs/pkgs/applications/misc/hello/default.nix:1:1
called with unexpected argument 'name', at /nix/store/mi0xpwzl81c7dgpr09qd67knbc24xab5-nixpkgs-21.05pre274251.f5f6dc053b1/nixpkgs/lib/customisation.nix:69:16
</code></pre><p>Okay, well, I have no idea how <code>override</code> works. Why does the manual introduce this without explaining how to use it? This is literally all that section 2.5 contains. Just this one example that doesn‚Äôt actually tell me how to override packages. I <em>think</em> this ranks as the worst thing I have encountered in the Nix documentation so far.</p>
<h1 id=26-declarative-package-managementhttpswebarchiveorgweb20210318102415httpsnixosorgmanualnixpkgsstablesec-declarative-package-management><a href=https://web.archive.org/web/20210318102415/https://nixos.org/manual/nixpkgs/stable/#sec-declarative-package-management>2.6. Declarative Package Management</a></h1>
<p>Huh! Here we go. Okay, so <a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>in my last post</a> I said that I thought I would find some function in Nixpkgs that would allow me to build a user environment. And I did! It‚Äôs here. This seems to be telling me exactly how to do the thing I did in my last post.</p>
<blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>{</span>
    <span class=n>myPackages</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>buildEnv</span> <span class=p>{</span>
      <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-packages"</span><span class=p>;</span>
      <span class=n>paths</span> <span class=o>=</span> <span class=p>[</span>
        <span class=n>aspell</span>
        <span class=n>bc</span>
        <span class=n>coreutils</span>
        <span class=n>gdb</span>
        <span class=n>ffmpeg</span>
        <span class=n>nixUnstable</span>
        <span class=n>emscripten</span>
        <span class=n>jq</span>
        <span class=n>nox</span>
        <span class=n>silver-searcher</span>
      <span class=p>];</span>
    <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div></blockquote>
<p><code>pkgs.buildEnv</code>. Very interesting. It doesn‚Äôt really make sense to me how this works ‚Äì so this basically means we only have one package available in our Nixpkgs now?</p>
<blockquote>
<p>To install it into our environment, you can just run <code>nix-env -iA nixpkgs.myPackages</code>.</p>
</blockquote>
<p>That makes sense, yeah.</p>
<blockquote>
<p>If you want to load the packages to be built from a working copy of <code>nixpkgs</code> you just run <code>nix-env -f. -iA myPackages</code>.</p>
</blockquote>
<p>What? I think that means, like, basically <code>--file ./default.nix</code> ‚Äì I‚Äôm not sure why that statement is being made here. This seems like a confusing complication that isn‚Äôt really related to the topic at hand. I don‚Äôt see why this makes it more likely that you would not want to use channels. I don‚Äôt get it.</p>
<blockquote>
<p>To explore what‚Äôs been installed, just look through <code>~/.nix-profile/</code>. You can see that a lot of stuff has been installed. Some of this stuff is useful some of it isn‚Äôt. Let‚Äôs tell Nixpkgs to only link the stuff that we want:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>{</span>
    <span class=n>myPackages</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>buildEnv</span> <span class=p>{</span>
      <span class=n>name</span> <span class=o>=</span> <span class=s2>"my-packages"</span><span class=p>;</span>
      <span class=n>paths</span> <span class=o>=</span> <span class=p>[</span> <span class=cm>/* ... */</span> <span class=p>];</span>
      <span class=n>pathsToLink</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"/share"</span> <span class=s2>"/bin"</span> <span class=p>];</span>
    <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div></blockquote>
<p>Okay, that‚Äôs pretty cool, I guess? I don‚Äôt think the extra symlinks are really hurting me, though. But sure.</p>
<blockquote>
<p><code>pathsToLink</code> tells Nixpkgs to only link the paths listed which gets rid of the extra stuff in the profile. <code>/bin</code> and <code>/share</code> are good defaults for a user environment, getting rid of the clutter. If you are running on Nix on MacOS, you may want to add another path as well, <code>/Applications</code>, that makes GUI apps available.</p>
</blockquote>
<p>I quoted that mostly because I didn‚Äôt know that Nix <em>had</em> any GUI macOS apps. I‚Äôm kind of surprised. Maybe I can get rid of my Homebrew casks after all? I just assumed it wouldn‚Äôt do that. I‚Äôll have to look into it.</p>
<p>The manual goes on to describe a lot more things that I can do to this ‚Äì installing extra outputs to get documentation (the manual lists <code>man</code> and <code>doc</code> as relevant output names, but not our old friend <code>info</code>).</p>
<blockquote>
<p>This provides us with some useful documentation for using our packages. However, if we actually want those manpages to be detected by man, we need to set up our environment. This can also be managed within Nix expressions.</p>
</blockquote>
<p>My goodness. It goes on to describe, like, managing my <code>etc/profile.d</code> using Nix? By hand? I don‚Äôt need to do any of these things. My <code>man</code>, I have learned, detects those man pages just fine. I‚Äôm not really sure what is happening here ‚Äì this seems like a much more complicated solution than just using <code>nix-env</code> in the way that I did. I don‚Äôt get it.</p>
<p>Aha! The next section describes setting up <code>info</code> pages correctly. Okay, it‚Äôs pretty complicated. Basically adds this expression:</p>
<blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>postBuild</span> <span class=err>=</span> <span class=s1>''
</span><span class=s1>  if [ -x $out/bin/install-info -a -w $out/share/info ]; then
</span><span class=s1>    shopt -s nullglob
</span><span class=s1>    for i in $out/share/info/*.info $out/share/info/*.info.gz; do
</span><span class=s1>        $out/bin/install-info $i $out/share/info/dir
</span><span class=s1>    done
</span><span class=s1>  fi
</span><span class=s1>''</span><span class=p>;</span>
</code></pre></div></blockquote>
<p>I guess a lack of <code>install-info</code> is the reason I couldn‚Äôt look at the <code>coreutils</code> <code>info</code> page? Which lives in the <code>texinfoInteractive</code> package, I learn. Although, like, <em>surely</em> there are <code>man</code> pages for GNU <code>coreutils</code>, right? I realize I am not a daily Linux user. But like‚Ä¶ people don‚Äôt really use <code>info</code>, do they?</p>
<p>I ask a friend who runs Linux on his laptop and who ‚Äì as of March 2021 ‚Äì has a working webcam for the first time in his life.</p>
<pre tabindex=0><code>ian: doug can i do an experiment on you
</code></pre><p>And he reports that nope, he has <code>man install</code>, it works exactly like anything else, and it does not appear to be something specific to his distro ‚Äì he quotes the end of the man page:</p>
<pre tabindex=0><code>REPORTING BUGS
       GNU coreutils online help: &lt;https://www.gnu.org/software/coreutils/&gt;
       Report any translation bugs to &lt;https://translationproject.org/team/&gt;
COPYRIGHT
       Copyright ¬© 2020 Free Software Foundation, Inc.  License GPLv3+: GNU 
       GPL version 3 or later &lt;https://gnu.org/licenses/gpl.html&gt;. This is 
       free software: you are free to change and redistribute it.  There is 
       NO WARRANTY, to the extent permitted by law.
SEE ALSO
       Full documentation &lt;https://www.gnu.org/software/coreutils/install&gt;
       or available locally via: info '(coreutils) install invocation'
GNU coreutils 8.32             March 2020                        INSTALL(1)
</code></pre><p>Which certainly seems like a normal GNU thing, and not something Arch added to make his life better.</p>
<p>Alright, this is the end of the chapter. I didn‚Äôt try <code>packageOverrides</code> because‚Ä¶ well, because it seems bad? It seems worse than the thing I did? I don‚Äôt know. I don‚Äôt know why I would do this from a Nix config file. This just seems like a weird abuse of the concept of configuration, and of <code>packageOverrides</code> as well. I don‚Äôt really know what I would be breaking if I made my <code>nixpkgs</code> only contain a single package. Would I lose the ability to <code>nix-shell -p</code>? <code>nix-build</code>? Does this only affect <code>nix-env</code>, for some reason? Could I still <code>nix-env -qa</code>, or would that only return my one environment package?</p>
<p>Sigh fine I guess I‚Äôll test it.</p>
<pre><code>$ cat ~/.config/nixpkgs/config.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>allowUnfree</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>{</span>
      <span class=n>myPackages</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>buildEnv</span> <span class=p>{</span>
        <span class=n>name</span> <span class=o>=</span> <span class=s2>"ian-packages"</span><span class=p>;</span>
        <span class=n>paths</span> <span class=o>=</span> <span class=p>[</span>
          <span class=n>hello</span>
        <span class=p>];</span>
      <span class=p>};</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix-env -qaA nixpkgs.myPackages
ian-packages
</code></pre><p>So it <em>exists</em>. But so does <em>everything else</em>:</p>
<pre tabindex=0><code>$ nix-env -qa | wc -l
   32935
</code></pre><p>This is <em>not</em> how the manual said that <code>packageOverrides</code> behaved. To quote:</p>
<blockquote>
<p>It must be a function that takes pkgs as an argument and returns a modified set of packages.</p>
</blockquote>
<p>So it does not return a modified set of packages. It returns, like, a set of modifications to <em>apply</em> to the set of packages? I don‚Äôt know. I don‚Äôt know how the result is being interpreted. Obviously it‚Äôs not just mapping a set of packages to a new set of packages, which was how I read that.</p>
<p>But anyway, it seems like I can use it to ‚Äúadd‚Äù my own custom packages to the set. And of course I could have the config file <code>import</code> this list from my dotfiles or whatever, so I wouldn‚Äôt actually need to maintain my environment here. But I really like the <a href=https://github.com/ianthehenry/sd-nix><code>sd nix diff</code></a> command that I have, and I don‚Äôt know how I would re-create that, so it <em>seems like</em> my solution is both simpler and nicer. So. I‚Äôm just gonna stick with that.</p>
<p>But I am curious about this <code>buildEnv</code> character, because <a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>back in part 20</a> I thought I learned that the construction of the user environment actually took place in C++ code. I might be misremembering; it was a while ago now. So I look up the function in my Nixpkgs checkout, and find that yep, it‚Äôs a derivation that <em>runs a Perl script</em> to just create a whole bunch of symlinks. Huh! But this is <em>separate</em> from the code built into Nix to build the environment. Because <code>nix-env</code> doesn‚Äôt have a dependency on the contents of Nixpkgs ‚Äì that would be crazy.</p>
<p>This gives me a <em>sort of crazy idea</em>.</p>
<p>You may remember <a href=https://github.com/NixOS/nixpkgs/issues/112465>this bug I encountered</a> when I was trying to <a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>switch from Homebrew to Nix</a>, that prevented me from installing <code>mercurial</code>. But what if‚Ä¶ could I just‚Ä¶?</p>
<pre><code>$ cat ~/.config/nixpkgs/config.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>allowUnfree</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>{</span>
      <span class=n>mercurialHack</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>buildEnv</span> <span class=p>{</span>
        <span class=n>name</span> <span class=o>=</span> <span class=s2>"mercurial-workaround"</span><span class=p>;</span>
        <span class=n>paths</span> <span class=o>=</span> <span class=p>[</span> <span class=n>mercurial</span> <span class=p>];</span>
      <span class=p>};</span>
    <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix-env -iA nixpkgs.mercurialHack
installing 'mercurial-workaround'
these derivations will be built:
  /nix/store/63nk5cmxwfx37ar17pzrknlh0j84akg7-builder.pl.drv
  /nix/store/jba37vrkk4pb3sh0j4ff755nm2n4nhc6-mercurial-workaround.drv
building '/nix/store/63nk5cmxwfx37ar17pzrknlh0j84akg7-builder.pl.drv'...
building '/nix/store/jba37vrkk4pb3sh0j4ff755nm2n4nhc6-mercurial-workaround.drv'...
created 3 symlinks in user environment
building '/nix/store/bwk367244phrmp6hn8i0a3s3jlicqgb0-user-environment.drv'...
created 990 symlinks in user environment
</code></pre><p>Ahahaha. I can‚Äôt believe that worked. But yeah, the bug had nothing to do with Mercurial itself, it was just that the derivation had too many <code>meta</code> fields. But this weird Perl script doesn‚Äôt care about that. Haha. Oh man.</p>
<p>Well, that was fun.</p>
<p>But <code>packageOverrides</code> doesn‚Äôt play nicely with my <code>user.nix</code> thing. I have no idea when these overrides take place or which commands are going to actually use this. So I can‚Äôt‚Ä¶ just use this. But I can use <code>buildEnv</code> to do the same thing, declaratively:</p>
<pre tabindex=0><code>$ head -n4 ~/dotfiles/user.nix
with import &lt;nixpkgs&gt; {}; [
  (buildEnv { name = "mercurial-workaround"; paths = [ mercurial ]; } )
  cabal-install
  cacert
</code></pre><p>Lovely. This gets my <code>brew list</code> down to a modest:</p>
<pre tabindex=0><code>autoconf        nodenv          pkg-config      readline
node-build      openssl@1.1     pyenv
</code></pre><p>Plus, you know, all my casks. But perhaps we‚Äôll be rid of those soon as well.</p>
<hr>
<ul>
<li>How do I quickly ‚Äúgo to definition‚Äù of a package?</li>
<li>Why don‚Äôt I have <code>man</code> pages for <code>coreutils</code>?</li>
<li>Why do I have to explicitly install <code>info</code> pages for <code>coreutils</code>?</li>
<li>How do I print all output paths of a derivation?</li>
<li>What on earth is <code>builtins.placeholder</code> for?</li>
<li>What is <code>derivation.override</code>? A method?</li>
<li>How do I use <code>derivation.override</code>?</li>
<li>Can I install my macOS GUI apps with Nix?</li>
<li>Why is there <code>buildEnv</code> ‚Äì a function ‚Äì in the top-level of Nixpkgs, when I learned before that <code>nix-env</code> required all top-level things to be derivations?</li>
</ul>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>After going through all this I looked at the <code>coreutils</code> definition, and while I still don‚Äôt <em>really</em> understand why there is no <code>man</code> page distributed, I learned that there is a <code>coreutils-full</code> package that <em>does</em> include man pages, for whatever reason. So the ‚Äúeasy‚Äù way to do all this, is:</p>
<pre tabindex=0><code>nix-shell -p coreutils-full --run 'man install'
</code></pre><p><em>Obviously</em>.&nbsp;<a href=#fnref:1 class=footnote-backref role=doc-backlink>‚Ü©Ô∏é</a></p>
</li>
</ol>
</section></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22How%20to%20learn%20Nixpkgs%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Next up ‚ûú Overlays</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></strong>&nbsp;‚Üê&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
¬© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
