<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/ 
 saved date: Mon Jul 17 2023 13:35:16 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 44: More flakes, unfortunately</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"üåñ"}#dmt:hover::before{content:"üåó"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"üåí"}:root:not(.light-theme) #dmt:hover::before{content:"üåì"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}sup{font-size:75%}sup a::before{content:"["}sup a::after{content:"]"}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}.footnotes>ol{margin-top:1em}.footnotes li:not(.highlight){transition:background-color 1s}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}a.footnote-ref:visited,a.footnote-backref:visited,.notation-help-link-container a:visited{color:var(--link)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+section,main *+article,main *+blockquote,main *+div,main *+ul,main *+ol,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .nt{color:var(--palette-teal)}.highlight .w{color:var(--palette-text)}.highlight .mi{color:var(--palette-orange)}.highlight .sd{color:var(--palette-dim)}.highlight .s2{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 44: More flakes, unfortunately">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>
<meta name=description content="Okay. In the last post I got sort of an introduction to flakes, and I even wrote a flake, but I didn‚Äôt learn how to‚Ä¶ do anything with flakes. My flake provided an overlay, but I have no idea how to make my Nixpkgs actually use that overlay.
I have no idea what ‚Äúmy Nixpkgs‚Äù even means anymore. My channel? My flake? Everything I‚Äôve learned about Nix has been turned upside down.
But presumably if we keep reading, these blog posts will explain how to actually put them to use.">
<meta property=og:description content="Okay. In the last post I got sort of an introduction to flakes, and I even wrote a flake, but I didn‚Äôt learn how to‚Ä¶ do anything with flakes. My flake provided an overlay, but I have no idea how to make my Nixpkgs actually use that overlay.
I have no idea what ‚Äúmy Nixpkgs‚Äù even means anymore. My channel? My flake? Everything I‚Äôve learned about Nix has been turned upside down.
But presumably if we keep reading, these blog posts will explain how to actually put them to use.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-12-07>December 7, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>How to Learn Nix, Part&nbsp;44:<br>More flakes, unfortunately</a></h1>
</div>
<div class=post-content><p>Okay. In the last post I got sort of an introduction to flakes, and I even wrote a flake, but I didn‚Äôt learn how to‚Ä¶ do anything with flakes. My flake provided an overlay, but I have no idea how to make my Nixpkgs actually <em>use</em> that overlay.</p>
<p>I have no idea what ‚Äúmy Nixpkgs‚Äù even <em>means</em> anymore. My channel? My flake? Everything I‚Äôve learned about Nix has been turned upside down.</p>
<p>But presumably if we keep reading, these blog posts will explain how to actually put them to use.</p>
<h1 id=nix-flakes-part-2-evaluation-cachinghttpswwwtweagioblog2020-06-25-eval-cache><a href=https://www.tweag.io/blog/2020-06-25-eval-cache/>Nix Flakes, Part 2: Evaluation Caching</a></h1>
<blockquote>
<p>Nix evaluation is often quite slow. In this blog post, we‚Äôll have a look at a nice advantage of the hermetic evaluation model enforced by flakes: the ability to cache evaluation results reliably.</p>
</blockquote>
<p>Neat. That was something that I observed happening in the last post, when I was trying to use <code>builtins.trace</code> to debug things. I‚Äôm excited about the idea of evaluation caching for two reasons:</p>
<ol>
<li><code>nix-shell</code> takes like two seconds before it actually enters a shell.</li>
<li>Scripts written with <code>nix-shell -i</code> take like two seconds before they actually start running.</li>
</ol>
<p>I‚Äôm aware of a <a href=https://github.com/xzfc/cached-nix-shell>third-party thing</a> that tries to solve the latter problem, by caching evaluation results, but I haven‚Äôt actually used it. I have tried to stick as close as possible to ‚Äúvanilla Nix,‚Äù so I‚Äôm excited to hear that this is going to be a first-party feature.</p>
<p>Let‚Äôs see. The blog post starts by saying that Nix is slow, and explaining that you can‚Äôt cache things safely, because pre-flakes evaluation is not ‚Äúhermetic.‚Äù I‚Äôm with you so far.</p>
<blockquote>
<p>(As an aside: for a while, Nix has had an experimental replacement for <code>nix-env -qa</code> called <code>nix search</code>, which used an ad hoc cache for package metadata. It had exactly this cache invalidation problem: it wasn‚Äôt smart enough to figure out whether its cache was up to date with whatever revision of Nixpkgs you were using. So it had a manual flag <code>--update-cache</code> to allow the user to force cache invalidation.)</p>
</blockquote>
<p>I‚Äôm personally kind of happy to see the end of <code>--update-cache</code>, even if it means <code>nix search</code> is slower, but that‚Äôs sort of irrelevant.</p>
<p>Oh look! The blog post actually goes into the implementation:</p>
<blockquote>
<p>The cache is implemented using a simple SQLite database that stores the values of flake output attributes. After the first command above, the cache looks like this:</p>
<pre><code>$ sqlite3 ~/.cache/nix/eval-cache-v1/302043eedfbce13ecd8169612849f6ce789c26365c9aa0e6cfd3a772d746e3ba.sqlite .dump
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=n>PRAGMA</span><span class=w> </span><span class=n>foreign_keys</span><span class=o>=</span><span class=k>OFF</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>BEGIN</span><span class=w> </span><span class=k>TRANSACTION</span><span class=p>;</span><span class=w>
</span><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=p>(</span><span class=w>
</span><span class=w>    </span><span class=n>parent</span><span class=w>      </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>name</span><span class=w>        </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>type</span><span class=w>        </span><span class=nb>integer</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=n>value</span><span class=w>       </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=p>(</span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=s1>''</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>'packages'</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>'legacyPackages'</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>'x86_64-linux'</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>'firefox'</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>NULL</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=s1>'type'</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=s1>'derivation'</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=s1>'drvPath'</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=s1>'/nix/store/7mz8pkgpl24wyab8nny0zclvca7ki2m8-firefox-75.0.drv'</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=s1>'outPath'</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=s1>'/nix/store/5x1i2gp8k95f2mihd6aj61b5lydpz5dy-firefox-75.0'</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Attributes</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=s1>'outputName'</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=s1>'out'</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></code></pre></div></blockquote>
<p>Neat. Okay.</p>
<blockquote>
<p>The name of the SQLite database, <code>302043eedf‚Ä¶.sqlite</code> in this example, is derived from the contents of the top-level flake. Since the flake‚Äôs lock file contains content hashes of all dependencies, this is enough to efficiently and completely capture all files that might influence the evaluation result. (In the future, we‚Äôll optimise this a bit more: for example, if the flake is a Git repository, we can simply use the Git revision as the cache name.)</p>
</blockquote>
<p>Sure. Fair enough.</p>
<p>Oh, I learn an interesting thing here.</p>
<p>I might have be looking at the wrong performance numbers when I timed <code>nix search</code> in the last post.</p>
<pre tabindex=0><code>$ time nix search nixpkgs git &gt;/dev/null
[5.6/0.0 MiB DL] downloading 'https://api.github.com/repos/NixOS/nixpkgs/tarbal
</code></pre><p>IT DID THE DOWNLOAD THING AGAIN. What the heck? What is it downloading? Why is it downloading anything? I happened to copy it quickly enough that time, so I can see that it‚Äôs downloading Nixpkgs‚Ä¶ but why? I haven‚Äôt collected garbage. I haven‚Äôt done <em>anything weird</em> on this computer since the last time I ran Nix search. What is Nix <em>doing?</em></p>
<p>Anyway, here‚Äôs the damage:</p>
<pre tabindex=0><code>$ time nix search nixpkgs git &gt;/dev/null
24.43s user 37.05s system 89% cpu 1:08.43 total
</code></pre><p>Yeah, it took a full minute because it had to download and decompress all of Nixpkgs. <em>Even though I didn‚Äôt ask it to.</em> Man, that‚Äôs really bad. I sort of‚Ä¶ hate Nix 2.4 so far, just because of this one issue.</p>
<p>Nix 2.3 had a lot of UX problems, but at least the problems were <em>predictable</em>. But with Nix 2.4, I don‚Äôt know when a command is going to randomly take 34 times longer than I expect it to, because Nix decided that the <em>one moment I asked it to do something</em> was the right time to perform some very slow housekeeping.</p>
<p>Oof. There had better be an option to disable this. This is horrible.</p>
<p><em>Anyway.</em></p>
<p>As you may recall, I was in the middle of trying to do something, before Nix decided that actually it was time to do something else.</p>
<p>Ugh.</p>
<p>Anyway: subsequent invocations of the same command are quick:</p>
<pre tabindex=0><code>$ time nix search nixpkgs git &gt;/dev/null
1.90s user 0.08s system 97% cpu 2.039 total
</code></pre><p>But this blog post has made me suspect that it‚Äôs because I searched for the same package. If I try:</p>
<pre tabindex=0><code>$ time nix search nixpkgs mercurial &gt;/dev/null
1.72s user 0.05s system 98% cpu 1.792 total
</code></pre><p>Okay, no, it‚Äôs still very fast. Even faster, actually, probably because I searched for a longer string and that‚Äôs how computers work. Or because there were fewer results. Or, well, probably both of those things, really.</p>
<p>I tried a couple other packages, and I‚Äôll stand by my statement in the previous blog post that 2.4‚Äôs <code>nix search</code> takes about twice as long as 2.3‚Äôs <code>nix search</code>, and that that‚Äôs an acceptable sacrifice for the lack of manual cache invalidation. But I will add a strong caveat that the new auto-updating-Nixpkgs behavior is so completely user-hostile that I‚Äôm going to have to go back to Homebrew if I can‚Äôt disable that.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p>
<p>Okay. Deep breaths. It‚Äôs going to be okay.</p>
<p>Oh, look! The blog post says something about cache invalidation:</p>
<blockquote>
<p>There is only one way in which cached results can become ‚Äústale‚Äù, in a way. Nix evaluation produces store derivations such as <code>/nix/store/7mz8pkgpl24wyab8nny0zclvca7ki2m8-firefox-75.0.drv</code> as a side effect. (<code>.drv</code> files are essentially a serialization of the dependency graph of a package.) These store derivations may be garbage-collected. In that case, the evaluation cache points to a path that no longer exists. Thus, Nix checks whether the <code>.drv</code> file still exist, and if not, falls back to evaluating normally.</p>
</blockquote>
<p>Well, okay sure, but this does nothing to explain why you choose to just randomly refresh the Nixpkgs repo while I‚Äôm in the middle of doing something.</p>
<p>The blog post goes on to talk about the idea of <em>sharing</em> evaluation caches and downloading them from the internet. Which is funny, to me. We sort of‚Ä¶ already do that, right? Like, you can download a <code>.drv</code> file from a substituter, right? This is just‚Ä¶ because flakes are a new concept, you need a new substitution mechanism. Hmm.</p>
<p>Well, that‚Äôs all for this blog post. Still no idea how to use flakes. Let‚Äôs try the next one.</p>
<h1 id=nix-flakes-part-3-managing-nixos-systemshttpswwwtweagioblog2020-07-31-nixos-flakes><a href=https://www.tweag.io/blog/2020-07-31-nixos-flakes/>Nix Flakes, Part 3: Managing NixOS systems</a></h1>
<p>Oh. Oh no. I don‚Äôt care about that. Nor do I have a way to follow along at home. It does seem to describe how to <em>use</em> flakes, sort of, but it involves editing your NixOS configuration files, which obviously‚Ä¶ I do not have.</p>
<p>It describes how to apply <code>overlays</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix>  <span class=n>outputs</span> <span class=err>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=n>nix</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>nixosConfigurations</span><span class=o>.</span><span class=n>container</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
      <span class=o>...</span>
      <span class=n>modules</span> <span class=o>=</span>
        <span class=p>[</span>
          <span class=p>({</span> <span class=n>pkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>{</span>
            <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span> <span class=n>nix</span><span class=o>.</span><span class=n>overlay</span> <span class=p>];</span>
            <span class=o>...</span>
          <span class=p>})</span>
        <span class=p>];</span>
    <span class=p>};</span>
  <span class=p>};</span>
<span class=err>}</span>
</code></pre></div><p>But only when defining a ‚ÄúNixOS container‚Äù flake. Nothing about how to use overlays myself.</p>
<p>Hmm. It goes on to say:</p>
<blockquote>
<p>It‚Äôs often convenient to pin the <code>nixpkgs</code> flake to the exact version of <code>nixpkgs</code> used to build the system. This ensures that commands like <code>nix shell nixpkgs#&lt;package&gt;</code> work more efficiently since many or all of the dependencies of <code>&lt;package&gt;</code> will already be present. Here is a bit of NixOS configuration that pins <code>nixpkgs</code> in the system-wide flake registry:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>nix</span><span class=o>.</span><span class=n>registry</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>flake</span> <span class=err>=</span> <span class=n>nixpkgs</span><span class=p>;</span>
</code></pre></div><p>Note that this only affects commands that reference <code>nixpkgs</code> without further qualifiers; more specific flake references like <code>nixpkgs/nixos-20.03</code> or <code>nixpkgs/348503b6345947082ff8be933dda7ebeddbb2762</code> are unaffected.</p>
</blockquote>
<p>But again, no hint of how to do this outside of NixOS.</p>
<p>And that‚Äôs the end! That‚Äôs it. That‚Äôs the introduction and tutorial.</p>
<p>Nothing about how to use flakes outside of NixOS.</p>
<p>So I suppose I‚Äôll have to look for myself.</p>
<p>Let‚Äôs try reading the man pages.</p>
<p>Er, well, there are no man pages for the new <code>nix</code> commands. But the <code>--help</code> text is very long, and formatted <em>sort of</em> like a man page. So we‚Äôll start there.</p>
<h1 id=nix-flake---help><code>nix flake --help</code></h1>
<p>I learn a bit of terminology, that I have seen before:</p>
<blockquote>
<p>A flake is a filesystem tree (typically fetched from a Git repository or a tarball) that contains a file named <code>flake.nix</code> in the root directory. <code>flake.nix</code> specifies some metadata about the flake such as dependencies (called inputs), as well as its outputs (the Nix values such as packages or NixOS modules provided by the flake).</p>
</blockquote>
<p>And, more importantly:</p>
<blockquote>
<p>Flake references (flakerefs) are a way to specify the location of a flake. These have two different forms:</p>
<ul>
<li>An attribute set representation, e.g.</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
<span class=n>type</span> <span class=o>=</span> <span class=s2>"github"</span><span class=p>;</span>
<span class=n>owner</span> <span class=o>=</span> <span class=s2>"NixOS"</span><span class=p>;</span>
<span class=n>repo</span> <span class=o>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>The only required attribute is <code>type</code>. The supported types are listed
below.</p>
<ul>
<li>A URL-like syntax, e.g.</li>
</ul>
<pre tabindex=0><code>github:NixOS/nixpkgs
</code></pre><p>These are used on the command line as a more convenient alternative to
the attribute set representation. For instance, in the command</p>
<pre tabindex=0><code># nix build github:NixOS/nixpkgs#hello
</code></pre></blockquote>
<p>I‚Äôm going to stop right here and say that it‚Äôs using <code>#</code> as a prompt character‚Ä¶? Instead of <code>$</code>? Which I understand as convention for ‚Äúrun this command as root.‚Äù But‚Ä¶ I have no idea why the manual used that here. It doesn‚Äôt seem to do it anywhere else, so maybe it was just a typo. Anyway.</p>
<blockquote>
<p><code>github:NixOS/nixpkgs</code> is a flake reference (while <code>hello</code> is an output attribute). They are also allowed in the inputs attribute of a flake, e.g.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=err>=</span> <span class=sd>github:NixOS/nixpkgs</span><span class=p>;</span>
</code></pre></div><p>is equivalent to</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=err>=</span> <span class=p>{</span>
<span class=n>type</span> <span class=o>=</span> <span class=s2>"github"</span><span class=p>;</span>
<span class=n>owner</span> <span class=o>=</span> <span class=s2>"NixOS"</span><span class=p>;</span>
<span class=n>repo</span> <span class=o>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></blockquote>
<p>Okaaaaay. Does that mean that, like, that‚Äôs new Nix syntax?</p>
<pre tabindex=0><code>nix-repl&gt; github:NixOS/nixpkgs
"github:NixOS/nixpkgs"
</code></pre><p>No. Okay. That‚Äôs still parsing as a string, using the weird unquoted URL syntax. Does it parse <em>differently</em> during flake evaluation? Surely not, right? <em>Surely not.</em></p>
<p>I don‚Äôt know how to test that, because I don‚Äôt know how to evaluate flakes. Flakes are still weird black boxes to me. But I‚Äôm going to <em>assume</em> that the manual is speaking loosely, when it calls those equivalent.</p>
<p>It then gives lots of examples of different syntax for flakerefs. Files, <code>github:</code> paths, <code>git+https://</code> URIs, compressed tarballs over <code>https://</code>. Okay neat. Apparently <code>.tar.gz</code> files can be ‚Äúflakes‚Äù as well.</p>
<blockquote>
<p><strong>Flake reference attributes</strong></p>
<p>The following generic flake reference attributes are supported:</p>
<ul>
<li>
<p><code>dir</code>: The subdirectory of the flake in which <code>flake.nix</code> is located. This parameter enables having multiple flakes in a repository or tarball. The default is the root directory of the flake.</p>
</li>
<li>
<p><code>narHash</code>: The hash of the NAR serialisation (in SRI format) of the contents of the flake. This is useful for flake types such as tarballs that lack a unique content identifier such as a Git commit hash.</p>
</li>
</ul>
</blockquote>
<p>This is the next section of the manual. I think that this is documenting the special magic attributes that Nix implicitly attaches to the attribute-set-not-attribute-set value that flakes have in the Nix expression language, though it doesn‚Äôt say that explicitly. It lists:</p>
<ul>
<li><code>dir</code></li>
<li><code>narHash</code></li>
<li><code>rev</code> (if applicable)</li>
<li><code>ref</code> (if applicable)</li>
<li><code>revCount</code> (if applicable)</li>
<li><code>lastModified</code></li>
</ul>
<p>Is that all of them? Is this list exhaustive? There‚Äôs no way to confirm, because I don‚Äôt know how to observe a flake in motion.</p>
<p>It then lists all the possible types, as it promised it would.</p>
<p>The first is <code>path</code>, which is also the most complicated. I learn that if you supply a path to a local Git repo it‚Äôs smart enough to treat it like a Git thing, and not a regular directory.</p>
<blockquote>
<p><code>path</code> generally must be an absolute path. However, on the command line, it can be a relative path (e.g. <code>.</code> or <code>./foo</code>) which is interpreted as relative to the current directory. In this case, it must start with <code>.</code> to avoid ambiguity with registry lookups (e.g. <code>nixpkgs</code> is a registry lookup; <code>./nixpkgs</code> is a relative path).</p>
</blockquote>
<p>Good to note; nice UI touch. The other types are simpler:</p>
<ul>
<li><code>git</code></li>
<li><code>mercurial</code> (!)</li>
<li><code>tarball</code></li>
<li><code>github</code></li>
<li><code>indirect</code></li>
</ul>
<p>Where <code>indirect</code> means ‚Äúsomething in the registry.‚Äù I can apparently type such ‚Äúflakerefs‚Äù as <code>nixpkgs</code> or as <code>flake:nixpkgs</code>.</p>
<p><em>Aha</em>. And then it describes flakes, and <em>here</em> it lists the attributes that flakes have:</p>
<blockquote>
<p>In addition to the outputs of each input, each input in <code>inputs</code> also contains some metadata about the inputs. These are:</p>
<ul>
<li><code>outPath</code>: The path in the Nix store of the flake‚Äôs source tree.</li>
<li><code>rev</code>: The commit hash of the flake‚Äôs repository, if applicable.</li>
<li><code>revCount</code>: The number of ancestors of the revision <code>rev</code>. This is not available for github repositories, since they‚Äôre fetched as tarballs rather than as Git repositories.</li>
<li><code>lastModifiedDate</code>: The commit time of the revision <code>rev</code>, in the format <code>%Y%m%d%H%M%S</code> (e.g. <code>20181231100934</code>). Unlike <code>revCount</code>, this is available for both Git and GitHub repositories, so it‚Äôs useful for generating (hopefully) monotonically increasing version strings.</li>
<li><code>lastModified</code>: The commit time of the revision <code>rev</code> as an integer denoting the number of seconds since 1970.</li>
<li><code>narHash</code>: The SHA-256 (in SRI format) of the NAR serialization of the flake‚Äôs source tree.</li>
</ul>
</blockquote>
<p>Note that this is a <em>different</em> list than the list it gave earlier about flake attributes. What‚Äôs‚Ä¶ what? What was that first list? What did that mean, then?</p>
<p>Let‚Äôs see. It talks about specifying <code>inputs</code>. We sort of saw this already, but it goes into more detail.</p>
<blockquote>
<p>you can use the URL-like syntax:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>import-cargo</span><span class=o>.</span><span class=n>url</span> <span class=err>=</span> <span class=sd>github:edolstra/import-cargo</span><span class=p>;</span>
<span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=err>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
</code></pre></div></blockquote>
<p>Oh. I see that I misread this before, when I was asking about these values parsing differently. I didn‚Äôt notice the <code>.url</code> part. Okay. It seems a little surprising to me that you don‚Äôt just write <code>inputs.import-cargo = github:edolstra/import-cargo;</code>; that‚Äôs what I read it is as before. But okay. I will try to remember the extra <code>url</code> bit.</p>
<p>But that‚Äôs super weird, because then you could say something contradictory:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=err>=</span> <span class=p>{</span>
  <span class=n>type</span> <span class=o>=</span> <span class=s2>"github"</span><span class=p>;</span>
  <span class=n>owner</span> <span class=o>=</span> <span class=s2>"NixOS"</span><span class=p>;</span>
  <span class=n>repo</span> <span class=o>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
  <span class=n>url</span> <span class=o>=</span> <span class=s2>"github:ianthehenry/nothing"</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>And like‚Ä¶ do you ignore the <code>url</code>, in that case? I guess so? It feels weird. Maybe there‚Äôs a case when you would specify <code>url</code> and some other attributes‚Ä¶? I don‚Äôt know.</p>
<blockquote>
<p>It is also possible to omit an input entirely and only list it as expected function argument to outputs. Thus,</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>outputs</span> <span class=err>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=o>...</span><span class=p>;</span>
</code></pre></div><p>without an <code>inputs.nixpkgs</code> attribute is equivalent to</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=err>=</span> <span class=p>{</span>
  <span class=n>type</span> <span class=o>=</span> <span class=s2>"indirect"</span><span class=p>;</span>
  <span class=n>id</span> <span class=o>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></blockquote>
<p>Ah, okay. This explains the sort-of-weird implicit <code>nixpkgs</code> dependency I encountered before. It wasn‚Äôt magically hardcoded, it was just <em>inferred</em> from the inputs.</p>
<p>Which means that any typo is going to implicitly add a new input? I guess that‚Äôs not a big deal. You‚Äôd notice pretty easily.</p>
<blockquote>
<p>Repositories that don‚Äôt contain a <code>flake.nix</code> can also be used as inputs, by setting the input‚Äôs flake attribute to <code>false</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>grcov</span> <span class=err>=</span> <span class=p>{</span>
  <span class=n>type</span> <span class=o>=</span> <span class=s2>"github"</span><span class=p>;</span>
  <span class=n>owner</span> <span class=o>=</span> <span class=s2>"mozilla"</span><span class=p>;</span>
  <span class=n>repo</span> <span class=o>=</span> <span class=s2>"grcov"</span><span class=p>;</span>
  <span class=n>flake</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></blockquote>
<p>It doesn‚Äôt say anything about what that‚Ä¶ means? But it gives an example that uses <code>grcov</code> as if it‚Äôs a path, so it like‚Ä¶ I still don‚Äôt understand what a flake <em>is</em> in the Nix expression language, but it seems like these flake inputs that are not flakes are also flakes, in the expression language?</p>
<p>I dunno, y‚Äôall.</p>
<blockquote>
<p>Transitive inputs can be overridden from a <code>flake.nix</code> file. For example, the
following overrides the <code>nixpkgs</code> input of the <code>nixops</code> input:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixops</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=err>=</span> <span class=p>{</span>
  <span class=n>type</span> <span class=o>=</span> <span class=s2>"github"</span><span class=p>;</span>
  <span class=n>owner</span> <span class=o>=</span> <span class=s2>"my-org"</span><span class=p>;</span>
  <span class=n>repo</span> <span class=o>=</span> <span class=s2>"nixpkgs"</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></blockquote>
<p>That‚Äôs neat. I like that; I could see that being useful.</p>
<blockquote>
<p>It is also possible to ‚Äúinherit‚Äù an input from another input. This is useful
to minimize flake dependencies. For example, the following sets the nixpkgs
input of the top-level flake to be equal to the <code>nixpkgs</code> input of the <code>dwarffs</code>
input of the top-level flake:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=err>=</span> <span class=s2>"dwarffs/nixpkgs"</span><span class=p>;</span>
</code></pre></div></blockquote>
<p>Neat, okay. I saw that in the last post and correctly figured out what it meant.</p>
<p>It‚Äôs sort of weird that this is‚Ä¶ slash-separated? Like, it‚Äôs not:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=err>=</span> <span class=n>inputs</span><span class=o>.</span><span class=n>dwarffs</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=p>;</span>
</code></pre></div><p>Or whatever the correct recursive expression is. Instead it‚Äôs‚Ä¶ a string that sort of looks like a path. But whatever.</p>
<blockquote>
<p>Overrides and follows can be combined, e.g.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>inputs</span><span class=o>.</span><span class=n>nixops</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=err>=</span> <span class=s2>"dwarffs/nixpkgs"</span><span class=p>;</span>
</code></pre></div><p>sets the <code>nixpkgs</code> input of <code>nixops</code> to be the same as the <code>nixpkgs</code> input of
<code>dwarffs</code>. It is worth noting, however, that it is generally not useful to
eliminate transitive <code>nixpkgs</code> flake inputs in this way. Most flakes provide
their functionality through Nixpkgs overlays or NixOS modules, which are
composed into the top-level flake‚Äôs <code>nixpkgs</code> input; so their own <code>nixpkgs</code> input
is usually irrelevant.</p>
</blockquote>
<p>Aha!</p>
<p>This is the first hint we get of <em>how we might actually use flakes</em>. If I write a flake that has an input that contains an overlay, and also has an input that is <code>nixpkgs</code>, then my <code>nixpkgs</code> input is going to contain those overlays applied?</p>
<p>Is that‚Ä¶ is that statement saying that this is something Nix does automatically, or that this is conventially going to be the way that overlays will be used by ‚Äúthe top-level flake?‚Äù</p>
<p>I don‚Äôt know.</p>
<p>Next up we learn about lock files‚Ä¶ I am familiar with the general idea from all other package managers; if I ever have to understand the details at the level that the help text is explaining right now then something has gone horribly wrong.</p>
<p>And that‚Äôs it! That‚Äôs the whole thing.</p>
<p>Okay.</p>
<p>We didn‚Äôt really learn‚Ä¶ how to use flakes, still. How to apply overlays into ‚Äúmy‚Äù copy of Nixpkgs.</p>
<p>Like, say I want to do something very simple:</p>
<pre tabindex=0><code>$ nix build nixpkgs#git
zsh: no matches found: nixpkgs#git
</code></pre><p>Oh, have mercy.</p>
<p>Yes, I have <code>EXTENDED_GLOB</code> enabled in my <code>zsh</code>, which means that my shell treats <code>nixpkgs#git</code> as a <em>glob</em>, roughly equivalent to the following regular expression:</p>
<pre><code>nixpkgs+git
</code></pre>
<p>Of course, this is not what I want; this is never what I want. I use <code>EXTENDED_GLOB</code> so I can write <code>^negated</code> globs, and I don‚Äôt think I have ever tried to type a repeated glob like that.</p>
<p>But I can‚Äôt disable <em>only</em> that. So in order to type a ‚Äúflakeref‚Äù at the command line, I have to quote it:</p>
<pre tabindex=0><code>$ nix build 'nixpkgs#git'
[0.0 MiB DL] downloading 'https://api.github.com/repos/NixOS/nixpkgs/tarball/18e6b518427
</code></pre><p>And it‚Äôs just hanging again. Because it needs to download Nixpkgs ‚Äì <em>again</em> ‚Äì for some reason. Honestly, what is even happening here; how is it even possible that it doesn‚Äôt cache the ‚Äúflakes‚Äù in my registry? Isn‚Äôt it‚Ä¶ what is Nix <em>thinking</em> here?</p>
<p>I don‚Äôt know if I <em>want</em> to keep learning about Nix 2.4. This is‚Ä¶ this is just horrible to use.</p>
<p>So we‚Äôre going to take a brief digression into <code>man 5 nix.conf</code> to try to figure out how to disable‚Ä¶ whatever the hell this is.</p>
<p>I grep for <code>flake</code>, but there‚Äôs nothing promising. I try <code>update</code>, then <code>cache</code>‚Ä¶ nothing there. I read through every option individually, but can‚Äôt find anything that sounds relevant.</p>
<p>I search google for ‚Äúnix flake downloading constantly‚Äù and find <a href=https://discourse.nixos.org/t/nix-search-nixpkgs-skip-registry-update/15097>this Discourse thread</a>.</p>
<p>The answer says you can ‚Äúpin‚Äù <code>nixpkgs</code> to prevent re-downloading it constantly. I see that there is <code>nix registry pin</code>, and the help shows me another weird superuser prompt example:</p>
<pre><code># nix registry pin nixpkgs
</code></pre>
<p>I ran that ‚Äì or rather, I ran:</p>
<pre><code>$ nix registry pin nixpkgs
</code></pre>
<p>And it didn‚Äôt‚Ä¶ give me any output. It didn‚Äôt tell me what it pinned it to. But I can look at the flake:</p>
<pre tabindex=0><code>$ nix flake metadata nixpkgs
Resolved URL:  github:NixOS/nixpkgs/18e6b5184274305f2c9dc36141003473375a5df9
Locked URL:    github:NixOS/nixpkgs/18e6b5184274305f2c9dc36141003473375a5df9
Description:   A collection of packages for the Nix package manager
Path:          /nix/store/f7pd39anz0rmv3jv3yk07a8m74xn1dqj-source
Revision:      18e6b5184274305f2c9dc36141003473375a5df9
Last modified: 2021-12-07 19:28:59
Inputs:
</code></pre><p>Okay. So like‚Ä¶ before I pinned it, it was literally making an HTTP request to GitHub every time I ran <code>search</code>? Is that‚Ä¶ that‚Äôs insane, right?</p>
<p>Let‚Äôs find out.</p>
<pre tabindex=0><code>$ nix registry unpin nixpkgs
error: 'unpin' is not a recognised command
Try 'nix --help' for more information.
</code></pre><p>Sigh of course. Though note that <code>nix --help</code> has absolutely no help; you need to run <code>nix registry --help</code> instead.</p>
<p>Er, sorry, that doesn‚Äôt have any information about unpinning either. You have to look in <code>nix registry pin --help</code>, of course. I do that, and learn that I need to <code>nix registry remove</code>‚Ä¶? But I don‚Äôt want to remove <code>nixpkgs</code>. I just want to unpin it.</p>
<p>So it seems like what‚Äôs actually happening is:</p>
<p><code>nix registry pin</code> didn‚Äôt ‚Äúpin‚Äù anything. It added a new entry to my ‚Äúuser‚Äù registry that shadows the <code>nixpkgs</code> entry in the ‚Äúglobal‚Äù registry.</p>
<pre tabindex=0><code>$ nix registry list | grep nixpkgs
user   flake:nixpkgs github:NixOS/nixpkgs/18e6b5184274305f2c9dc36141003473375a5df9
global flake:nixpkgs github:NixOS/nixpkgs
</code></pre><p>Then I can run <code>nix registry remove nixpkgs</code> to remove the entry from my user registry ‚Äì but not the global registry.</p>
<pre tabindex=0><code>$ nix registry remove nixpkgs

$ nix registry list | grep nixpkgs
global flake:nixpkgs github:NixOS/nixpkgs
</code></pre><p>Okay. And now I can disable my Wi-Fi‚Ñ¢ and try again‚Ä¶</p>
<pre tabindex=0><code>$ nix search nixpkgs git
warning: you don't have Internet access; disabling some network-dependent features
...
</code></pre><p>Ha! So.. it really was checking with GitHub to see if I had the latest version of the repo? It was able to search offline just fine, but the message implies that it <em>wanted</em> to transfer some hypertext anyway.</p>
<p>Oh my goodness.</p>
<p>Wow.</p>
<p>That‚Äôs‚Ä¶ that‚Äôs really insane default behavior.</p>
<p>But I don‚Äôt think it‚Äôs checking on <em>every</em> command. It has some kind of local cache, apparently, because I can still run <code>nix registry pin</code> without internet access, and it does work.</p>
<p>But there‚Äôs no <code>--verbose</code> or anything to explain what‚Äôs actually going on here or <em>when</em> it does decide to check. Nix is just‚Ä¶ randomly deciding to make HTTP requests to GitHub, when it feels like its registry needs updating?</p>
<p>Ugh. It used to be so easy to just <code>dtruss</code> this and find out. Now I need to like‚Ä¶ disable various macOS features just to be able to instrument system calls. Why am I using a mac, again? Oh yeah iOS. Stupid iOS.</p>
<p>Well, anyway, I have no idea. Nix‚Äôs behavior around registry updates feels like a crazy black box. I find <a href=https://github.com/NixOS/nix/pull/2890>this PR</a> which implies that the ‚Äúre-use most recently downloaded thing‚Äù behavior is only enabled when you‚Äôre offline, so maybe it really <em>is</em> checking in with GitHub every time? Oof. I dunno. This seems crazy, but that PR is more than two years old, so maybe things have changed.</p>
<p>Anyway‚Ä¶</p>
<p>So now if I want to update my Nix things‚Ä¶ instead of typing <code>nix-channel --update</code>, I‚Äôm supposed to type:</p>
<pre><code>$ nix registry remove nixpkgs

$ nix registry pin nixpkgs
</code></pre>
<p>To update things? Is that‚Ä¶ is that what I‚Äôm hearing here? Or can I just run <code>pin</code> again, and have it update? That would be surprising. I don‚Äôt know how to test it. While poking around, I find that my ‚Äúuser registry‚Äù seems to live in <code>~/.config/nix/registry.json</code>:</p>
<pre><code>$ cat ~/.config/nix/registry.json
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"flakes"</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>"from"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"sd"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>},</span>
      <span class=nt>"to"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"ianthehenry"</span><span class=p>,</span>
        <span class=nt>"ref"</span><span class=p>:</span> <span class=s2>"add-flakes"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"sd"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>"from"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>},</span>
      <span class=nt>"to"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lastModified"</span><span class=p>:</span> <span class=mi>1638934139</span><span class=p>,</span>
        <span class=nt>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-uV77+UK9rfcvCHM6eLYYNFp9iLhIJ6WUAPv4QcZ1pV0="</span><span class=p>,</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"NixOS"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"rev"</span><span class=p>:</span> <span class=s2>"18e6b5184274305f2c9dc36141003473375a5df9"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>2</span>
<span class=p>}</span>
</code></pre></div><p>That‚Äôs good to know, I guess.</p>
<p>Hmm.</p>
<p>How do I roll back these ‚Äúpin‚Äù updates? <code>nix-channel --rollback</code> has saved my skin many times. Do I like‚Ä¶ save the lock file that it creates, before I unpin? Do I just write down the rev that it was pinned to? Where does the lock file live?</p>
<p>Also‚Ä¶ am I really getting the latest revision of the Nixpkgs repo? And if so, is that what I <em>want?</em></p>
<p>I remember learning, while reading the Nix manual, that the unstable channel existed to lag the Nixpkgs repo so that tests could pass and binaries could be built and put in the cache, so that if you used the unstable channel you could trust that you wouldn‚Äôt have to compile everything from source.</p>
<p>I also remember learning that <a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>this didn‚Äôt really seem to be the case</a>, and there were lots of derivations without substitutes, despite whatever the manual had to say about the purpose of the unstable channel.</p>
<p>But now it seems‚Ä¶ Nix is abandoning that pretense, and is always giving me the tip of the repo? Like, <em>constantly</em>, against my will, whenever I try to run any command?</p>
<p>Hmm.</p>
<p>Very strange.</p>
<p>Well, I was trying to see if the overlays in my <code>sd</code> flake are available when I reference my <code>nixpkgs</code> flake. But it seems that they aren‚Äôt.</p>
<p>How do I ‚Äúapply‚Äù the overlay in my <code>sd</code> flake to my <code>nixpkgs</code> flake?</p>
<p>I have no idea. My mental model is telling me that I <em>can‚Äôt</em>, and I would have to write my <em>own</em> <code>nixpkgs</code> flake and add it to my registry separately if I actually wanted to do this. And then I have no idea how I would update that. Hmm.</p>
<p>But maybe I don‚Äôt <em>want</em> to do that? Maybe there‚Äôs no point?</p>
<p>I thought it made sense to provide <code>sd</code> as an overlay, when I was thinking about <em>channels</em>. I wanted to be able to type <code>nixpkgs.sd</code>. But now‚Ä¶ now I‚Äôm thinking that that‚Äôs something I need to give up? I‚Äôm not sure why I would ever refer to just <code>nixpkgs</code>, in this day and age. It would be nice if my overlayed software showed up when I, like, <code>nix search nixpkgs</code>, but‚Ä¶ it‚Äôs not really vital for me.</p>
<p>Maybe I need to take the next step, and figure out how to actually start <em>using</em> flakes. How to upgrade my <code>shell.nix</code> files; how to replace <code>nix-env</code>. And then maybe it will be clear how to do this, or it will be clear why I don‚Äôt need to do this after all.</p>
<hr>
<ul>
<li>When does Nix decide to update unpinned flakes?</li>
<li>How do I roll back a Nix‚Ä¶ flake‚Ä¶ pin operation?</li>
</ul>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>Yes, I know that Homebrew does the same thing, and yes, it‚Äôs horrible there too, and the fact that Nix <em>didn‚Äôt</em> do this was a big selling point for me.&nbsp;<a href=#fnref:1 class=footnote-backref role=doc-backlink>‚Ü©Ô∏é</a></p>
</li>
</ol>
</section></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22More%20flakes%2c%20unfortunately%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://twitter.com/ianthehenry/status/1468450249576353793>comment via twitter</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Next up ‚ûú Fancy new profiles</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></strong>&nbsp;‚Üê&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
¬© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
