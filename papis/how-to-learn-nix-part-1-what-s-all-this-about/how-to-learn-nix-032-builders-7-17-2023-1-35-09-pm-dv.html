<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/builders/ 
 saved date: Mon Jul 17 2023 13:35:09 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 32: Builders</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"üåñ"}#dmt:hover::before{content:"üåó"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"üåí"}:root:not(.light-theme) #dmt:hover::before{content:"üåì"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main pre+div.highlight{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cm{color:var(--palette-dim)}.highlight .c1{color:var(--palette-dim)}.highlight .kn{color:var(--palette-teal)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .nv{color:var(--palette-red)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 32: Builders">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/builders/>
<meta name=description content="Yes, I took a long break from reading Nix documentation.
But I did not give up on Nix, just as Nix has not given up on me. I‚Äôve simply been busy, and finding myself less intrinsically motivated to read the Nixpkgs manual than I was when I was reading the Nix manual.
I know you were worried. The number of messages I got encouraging me to keep going, not to give up when I‚Äôm so close to the home stretch ‚Äì it was almost nonzero.
So here we go. Let‚Äôs get right back into it.">
<meta property=og:description content="Yes, I took a long break from reading Nix documentation.
But I did not give up on Nix, just as Nix has not given up on me. I‚Äôve simply been busy, and finding myself less intrinsically motivated to read the Nixpkgs manual than I was when I was reading the Nix manual.
I know you were worried. The number of messages I got encouraging me to keep going, not to give up when I‚Äôm so close to the home stretch ‚Äì it was almost nonzero.
So here we go. Let‚Äôs get right back into it.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-05-12>May 12, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>How to Learn Nix, Part&nbsp;32:<br>Builders</a></h1>
</div>
<div class=post-content><p>Yes, I took a long break from reading Nix documentation.</p>
<p>But I did not give up on Nix, just as Nix has not given up on me. I‚Äôve simply been busy, and finding myself less intrinsically motivated to read the Nixpkgs manual than I was when I was reading the Nix manual.</p>
<p>I know you were worried. The number of messages I got encouraging me to keep going, not to give up when I‚Äôm so close to the home stretch ‚Äì it was <em>almost</em> nonzero.</p>
<p>So here we go. Let‚Äôs get right back into it.</p>
<h1 id=chapter-11-fetchershttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-pkgs-fetchers><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-pkgs-fetchers>Chapter 11. Fetchers</a></h1>
<blockquote>
<p>When using Nix, you will frequently need to download source code and other files from the internet. Nixpkgs comes with a few helper functions that allow you to fetch fixed-output derivations in a structured way.</p>
</blockquote>
<p>I want to highlight the terminology here: ‚Äúhelper functions that allow you to fetch fixed-output derivations.‚Äù</p>
<p>I‚Äôm still trying to get a handle on the term ‚Äúderivation,‚Äù and I do not like the way that it‚Äôs used here.</p>
<p>My understanding so far is that helpers like <code>fetchurl</code> don‚Äôt ‚Äúfetch‚Äù derivations. They <em>return</em> derivations. Or to be persnickety about the language, they <em>evaluate to</em> fixed-output derivations.</p>
<p>You aren‚Äôt fetching the derivation: you‚Äôre <em>creating</em> a derivation which itself is responsible for fetching a source file, or a tarball, or whatever.</p>
<p>Now, I could update my understanding of the term derivation based on this new information, but I‚Äôm not going to. I am confident enough in my understanding from <a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>all the way back in part 11</a> that the language here is just incorrect.</p>
<p>Which is unfortunate, because I don‚Äôt think that <em>anywhere</em> in the preceding thousands of words of manual has this actually been spelled out. I only know that <code>fetchurl</code> returns a derivation because I read the source of <code>fetchurl</code>. If I hadn‚Äôt, I might still be very confused. This would the perfect place to explain how these fetchers work, though, so let‚Äôs see if the manual does that.</p>
<p>Alright, returning to the manual:</p>
<p>We learn the difference between <code>fetchurl</code> and <code>fetchzip</code>: one stores a file exactly; the other decompresses it.</p>
<blockquote>
<p>Despite the name, <code>fetchzip</code> is not limited to .zip files and can also be used with any tarball.</p>
</blockquote>
<p>Fair enough.</p>
<blockquote>
<p><code>fetchpatch</code> works very similarly to <code>fetchurl</code> with the same arguments expected. It expects patch files as a source and and performs normalization on them before computing the checksum. For example it will remove comments or other unstable parts that are sometimes added by version control systems and can change over time.</p>
</blockquote>
<p>Ah, neat. I remember <a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>seeing <code>fetchpatch</code> before</a> and vaguely wondering what its deal was.</p>
<p>We learn about some other fetchers: <code>fetchsvn</code>, <code>fetchgit</code>, <code>fetchfossil</code>, <code>fetchcvs</code>, and finally <code>fetchhg</code>. All pretty straightforward.</p>
<p>And then some helpers for common Internet services: <code>fetchFromGitHub</code>, <code>fetchFromGitLab</code>, <code>fetchFromGitiles</code>, <code>fetchFromBitbucket</code>, <code>fetchFromSavannah</code>, and <code>fetchFromRepoOrCz</code>. I‚Äôve never heard of <a href=https://savannah.gnu.org/>Savannah</a> before. I <em>think</em> my Google turned up the right Savannah. Also never heard of <a href=https://repo.or.cz/>repo.or.cz</a>.</p>
<p><code>rg</code> tells me that exactly two packages use <code>fetchFromRepoOrCz</code>:</p>
<pre tabindex=0><code>$ sd nix info tinycc
tcc-0.9.27 Small, fast, and embeddable C compiler and interpreter

$ sd nix info cdimgtools
cdimgtools-0.3 Tools to inspect and manipulate CD/DVD optical disc images
</code></pre><p>And <code>fetchFromSavannah</code> is used in exactly one place: in <code>config.nix</code> for the <code>ruby</code> package. It isn‚Äôt used to fetch the Ruby source: its used to fetch a package called <a href=https://savannah.gnu.org/projects/config><code>config</code></a>. I have never heard of this package before, but it seems to be present in Nixpkgs already as <code>nixpkgs.gnu-config</code>, where its source is fetched using <code>fetchgit</code> and a path to the Savannah repository.</p>
<p>So it seems like <code>nixpkgs.ruby</code> should just depend on that, and that maybe <code>fetchFromSavannah</code> is not 100% pulling its weight here.</p>
<h1 id=chapter-12-trivial-buildershttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-trivial-builders><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-trivial-builders>Chapter 12. Trivial Builders</a></h1>
<blockquote>
<p>Nixpkgs provides a couple of functions that help with building derivations.</p>
</blockquote>
<p>See, but the ‚Äúfetchers‚Äù are <em>also</em> functions that help with building derivations, but you never said that.</p>
<p>Also, it‚Äôs sort of confusing to use the term ‚Äúbuilding derivations.‚Äù I take it here to mean, like, constructing derivations. Creating derivations. Not <em>building</em> in the traditional sense of compilation and linking and whatnot.</p>
<p>Anyway.</p>
<p>First up is <code>runCommand</code>: it takes a string, and that string is run as a <code>bash</code> script. I <em>believe</em>. It doesn‚Äôt actually say <code>bash</code>, but I‚Äôm assuming here. I am also assuming that it‚Äôs run with the same <code>PATH</code> that <code>source $stdenv/setup</code> would give you.</p>
<p>But let‚Äôs take a look. It would be a trivial function to write ourselves, I think ‚Äì take the string, pass it as an argument to <code>bash -c</code>. Or write it to a file or whatever. Let‚Äôs see what the official version looks like:</p>
<pre><code>$ cat ~/src/nixpkgs/pkgs/build-support/trivial-builders.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>let</span>

  <span class=n>runCommand'</span> <span class=o>=</span> <span class=n>runLocal</span><span class=p>:</span> <span class=n>stdenv</span><span class=p>:</span> <span class=n>name</span><span class=p>:</span> <span class=n>env</span><span class=p>:</span> <span class=n>buildCommand</span><span class=p>:</span>
    <span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>({</span>
      <span class=n>name</span> <span class=o>=</span> <span class=n>lib</span><span class=o>.</span><span class=n>strings</span><span class=o>.</span><span class=n>sanitizeDerivationName</span> <span class=n>name</span><span class=p>;</span>
      <span class=k>inherit</span> <span class=n>buildCommand</span><span class=p>;</span>
      <span class=n>passAsFile</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"buildCommand"</span> <span class=p>];</span>
    <span class=p>}</span>
    <span class=o>//</span> <span class=p>(</span><span class=n>lib</span><span class=o>.</span><span class=n>optionalAttrs</span> <span class=n>runLocal</span> <span class=p>{</span>
          <span class=n>preferLocalBuild</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
          <span class=n>allowSubstitutes</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
       <span class=p>})</span>
    <span class=o>//</span> <span class=n>env</span><span class=p>);</span>

<span class=k>in</span>

<span class=k>rec</span> <span class=p>{</span>
<span class=o>...</span>
<span class=n>runCommand</span> <span class=o>=</span> <span class=n>runCommandNoCC</span><span class=p>;</span>
<span class=o>...</span>
<span class=n>runCommandNoCC</span> <span class=o>=</span> <span class=n>runCommand'</span> <span class=no>false</span> <span class=n>stdenvNoCC</span><span class=p>;</span>
<span class=o>...</span>
</code></pre></div><p>Okay! Yeah. Very simple. I recall <code>passAsFile</code> from <a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>part 13</a> ‚Äì so the builder will execute with an environment variable called <code>$buildCommand</code> which will be the <em>path</em> to a temporary file.</p>
<p>But wait‚Ä¶ this is a little too simple, isn‚Äôt it? How does it know‚Ä¶ to execute that file? I don‚Äôt recall <code>mkDerivation</code> treating <code>buildCommand</code> as some special argument. Or the <code>stdenv</code> builders making use of such a magic variable. Certainly that was not mentioned in <a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>the discussion of the ‚Äúgeneric builder‚Äù</a>.</p>
<p>But if we take a look at the source:</p>
<pre><code>$ grep 'genericBuild' -A8 ~/src/nixpkgs/pkgs/stdenv/generic/setup.sh
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>genericBuild<span class=o>()</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>"</span><span class=si>${</span><span class=nv>buildCommandPath</span><span class=k>:-</span><span class=si>}</span><span class=s2>"</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>source</span> <span class=s2>"</span><span class=nv>$buildCommandPath</span><span class=s2>"</span>
        <span class=k>return</span>
    <span class=k>fi</span>
    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>"</span><span class=si>${</span><span class=nv>buildCommand</span><span class=k>:-</span><span class=si>}</span><span class=s2>"</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>eval</span> <span class=s2>"</span><span class=nv>$buildCommand</span><span class=s2>"</span>
        <span class=k>return</span>
    <span class=k>fi</span>
</code></pre></div><p>It clearly <em>is</em> special. Huh.</p>
<p>Then we have <code>runCommandCC</code>, which puts <code>cc</code> in your environment. This is interesting: the bare <code>runCommand</code> references <code>stdenvNoCC</code>, which seems like something that I should have heard of by now. It seems like something I should use, when writing my own derivations, when I do not actually depend on <code>cc</code> (which I almost always will not). But the manual has never mentioned it before. Huh.</p>
<p>Then we have <code>runCommandLocal</code>, which will always execute the command, and never download a cached version from the wilderness.</p>
<blockquote>
<p>Note: This sets <code>allowSubstitutes</code> to <code>false</code>, so only use <code>runCommandLocal</code> if you are certain the user will always have a builder for the <code>system</code> of the derivation. This should be true for most trivial use cases (e.g. just copying some files to a different location or adding symlinks), because there the <code>system</code> is usually the same as <code>builtins.currentSystem</code>.</p>
</blockquote>
<p>I don‚Äôt really understand what this comment means. How can I be ‚Äúcertain the user will always have a builder for the current system?‚Äù Is <code>system == builtins.currentSystem</code> sufficient? The comment implies that, but I have no idea what it actually means by ‚Äúhave a builder for the <code>system</code>.‚Äù What‚Äôs the builder? <code>bash</code>? I don‚Äôt‚Ä¶ what?</p>
<p>There‚Äôs a comment in the source:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1># `runCommandCCLocal` left out on purpose.</span>
<span class=c1># We shouldn‚Äôt force the user to have a cc in scope.</span>
</code></pre></div><p>Which doesn‚Äôt really explain anything.</p>
<p>It makes me think that setting <code>allowSubstitutes = false</code>‚Ä¶ means that <em>nothing</em> is going to be downloaded? It doesn‚Äôt just disable downloading the output of <em>this</em> derivation ‚Äì as I would have expected ‚Äì but also <em>all of its dependencies?</em> Is that a correct reading of this?</p>
<p>That seems‚Ä¶ crazy to me. I don‚Äôt believe that. But then I have no idea what the note is talking about.</p>
<p>Next up, a grab bag: <code>writeTextFile</code>, <code>writeText</code>, <code>writeTextDir</code>, <code>writeScript</code>, <code>writeScriptBin</code>.</p>
<p><code>writeTextFile</code> is the only one that‚Äôs actually described. The manual says that it writes a text file. Presumably it takes a string as input, and writes that string as a text file. But the manual doesn‚Äôt say that. The manual hardly says anything, actually. The only other thing it says is ‚ÄúYou can also set <code>executable</code> to <code>true</code> to make this file have the executable bit set.‚Äù So maybe this takes a map?</p>
<p>The others are just ‚Äúwrappers over <code>writeTextFile</code>.‚Äù But there‚Äôs nothing about what they do, or how they work, or why I would use them.</p>
<p>So‚Ä¶ yeah we‚Äôre gonna go to the source.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/* Writes a text file to the nix store.
</span><span class=cm> * The contents of text is added to the file in the store.
</span><span class=cm> *
</span><span class=cm> * Examples:
</span><span class=cm> * # Writes my-file to /nix/store/&lt;store path&gt;
</span><span class=cm> * writeTextFile {
</span><span class=cm> *   name = "my-file";
</span><span class=cm> *   text = ''
</span><span class=cm> *     Contents of File
</span><span class=cm> *   '';
</span><span class=cm> * }
</span><span class=cm> * # See also the `writeText` helper function below.
</span><span class=cm> *
</span><span class=cm> * # Writes executable my-file to /nix/store/&lt;store path&gt;/bin/my-file
</span><span class=cm> * writeTextFile {
</span><span class=cm> *   name = "my-file";
</span><span class=cm> *   text = ''
</span><span class=cm> *     Contents of File
</span><span class=cm> *   '';
</span><span class=cm> *   executable = true;
</span><span class=cm> *   destination = "/bin/my-file";
</span><span class=cm> * }
</span><span class=cm> */</span>
<span class=n>writeTextFile</span> <span class=err>=</span>
  <span class=p>{</span> <span class=n>name</span> <span class=c1># the name of the derivation</span>
  <span class=o>,</span> <span class=n>text</span>
  <span class=o>,</span> <span class=n>executable</span> <span class=o>?</span> <span class=no>false</span> <span class=c1># run chmod +x ?</span>
  <span class=o>,</span> <span class=n>destination</span> <span class=o>?</span> <span class=s2>""</span>   <span class=c1># relative path appended to $out eg "/bin/foo"</span>
  <span class=o>,</span> <span class=n>checkPhase</span> <span class=o>?</span> <span class=s2>""</span>    <span class=c1># syntax checks, e.g. for scripts</span>
  <span class=p>}:</span>
  <span class=n>runCommand</span> <span class=n>name</span>
    <span class=p>{</span> <span class=k>inherit</span> <span class=n>text</span> <span class=n>executable</span><span class=p>;</span>
      <span class=n>passAsFile</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>"text"</span> <span class=p>];</span>
      <span class=c1># Pointless to do this on a remote machine.</span>
      <span class=n>preferLocalBuild</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
      <span class=n>allowSubstitutes</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=s1>''
</span><span class=s1>      n=$out</span><span class=si>${</span><span class=n>destination</span><span class=si>}</span><span class=s1>
</span><span class=s1>      mkdir -p "$(dirname "$n")"
</span><span class=s1>
</span><span class=s1>      if [ -e "$textPath" ]; then
</span><span class=s1>        mv "$textPath" "$n"
</span><span class=s1>      else
</span><span class=s1>        echo -n "$text" &gt; "$n"
</span><span class=s1>      fi
</span><span class=s1>
</span><span class=s1>      </span><span class=si>${</span><span class=n>checkPhase</span><span class=si>}</span><span class=s1>
</span><span class=s1>
</span><span class=s1>      (test -n "$executable" &amp;&amp; chmod +x "$n") || true
</span><span class=s1>    ''</span><span class=p>;</span>

</code></pre></div><p>Look at that. Much better documentation than the manual.</p>
<p>It‚Äôs weird that we don‚Äôt just‚Ä¶ it‚Äôs weird that we <code>passAsFile</code> and then <code>mv</code>. We can‚Äôt just like‚Ä¶ <code>passAsTheRightThing</code>? I dunno. There is some mechanism by which <code>passAsFile</code> already knows how to create files somewhere. It seems weird to do it‚Ä¶ this way. Anyway. It probably doesn‚Äôt really matter.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/*
</span><span class=cm> * Writes a text file to nix store with no optional parameters available.
</span><span class=cm> *
</span><span class=cm> * Example:
</span><span class=cm> * # Writes contents of file to /nix/store/&lt;store path&gt;
</span><span class=cm> * writeText "my-file"
</span><span class=cm> *   ''
</span><span class=cm> *   Contents of File
</span><span class=cm> *   '';
</span><span class=cm> *
</span><span class=cm>*/</span>
<span class=n>writeText</span> <span class=err>=</span> <span class=n>name</span><span class=p>:</span> <span class=n>text</span><span class=p>:</span> <span class=n>writeTextFile</span> <span class=p>{</span><span class=k>inherit</span> <span class=n>name</span> <span class=n>text</span><span class=p>;};</span>
</code></pre></div><p>Ah. So there‚Äôs the trivial one.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/*
</span><span class=cm> * Writes a text file to nix store in a specific directory with no
</span><span class=cm> * optional parameters available.
</span><span class=cm> *
</span><span class=cm> * Example:
</span><span class=cm> * # Writes contents of file to /nix/store/&lt;store path&gt;/share/my-file
</span><span class=cm> * writeTextDir "share/my-file"
</span><span class=cm> *   ''
</span><span class=cm> *   Contents of File
</span><span class=cm> *   '';
</span><span class=cm> *
</span><span class=cm>*/</span>
<span class=n>writeTextDir</span> <span class=err>=</span> <span class=n>path</span><span class=p>:</span> <span class=n>text</span><span class=p>:</span> <span class=n>writeTextFile</span> <span class=p>{</span>
  <span class=k>inherit</span> <span class=n>text</span><span class=p>;</span>
  <span class=n>name</span> <span class=o>=</span> <span class=nb>builtins</span><span class=o>.</span><span class=nb>baseNameOf</span> <span class=n>path</span><span class=p>;</span>
  <span class=n>destination</span> <span class=o>=</span> <span class=s2>"/</span><span class=si>${</span><span class=n>path</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div><p>This one feels pretty unnecessary to me, but <code>rg</code> tells me that it‚Äôs used a ton in the <code>nixos/</code> subdirectory, and in a couple places elsewhere. A random excerpt:</p>
<pre tabindex=0><code>nixos/tests/haproxy.nix
27:          documentRoot = pkgs.writeTextDir "index.txt" "We are all good!";
</code></pre><p>Aw.</p>
<p><code>writeScript</code> is just <code>writeText</code> with <code>executable = true</code>. <code>writeScriptBin</code> is just <code>writeScript</code> with a destination of <code>bin</code>. I can see how all of these are useful, in their own ways.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/*
</span><span class=cm> * Similar to writeScript. Writes a Shell script and checks its syntax.
</span><span class=cm> * Automatically includes interpreter above the contents passed.
</span><span class=cm> *
</span><span class=cm> * Example:
</span><span class=cm> * # Writes my-file to /nix/store/&lt;store path&gt; and makes executable.
</span><span class=cm> * writeShellScript "my-file"
</span><span class=cm> *   ''
</span><span class=cm> *   Contents of File
</span><span class=cm> *   '';
</span><span class=cm> *
</span><span class=cm>*/</span>
<span class=n>writeShellScript</span> <span class=err>=</span> <span class=n>name</span><span class=p>:</span> <span class=n>text</span><span class=p>:</span>
  <span class=n>writeTextFile</span> <span class=p>{</span>
    <span class=k>inherit</span> <span class=n>name</span><span class=p>;</span>
    <span class=n>executable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
    <span class=n>text</span> <span class=o>=</span> <span class=s1>''
</span><span class=s1>      #!</span><span class=si>${</span><span class=n>runtimeShell</span><span class=si>}</span><span class=s1>
</span><span class=s1>      </span><span class=si>${</span><span class=n>text</span><span class=si>}</span><span class=s1>
</span><span class=s1>      ''</span><span class=p>;</span>
    <span class=n>checkPhase</span> <span class=o>=</span> <span class=s1>''
</span><span class=s1>      </span><span class=si>${</span><span class=n>stdenv</span><span class=o>.</span><span class=n>shell</span><span class=si>}</span><span class=s1> -n $out
</span><span class=s1>    ''</span><span class=p>;</span>
  <span class=p>};</span>
</code></pre></div><p>Okay, cute.</p>
<p>This one isn‚Äôt documented in the manual, but it seems pretty useful. We also have <code>writeShellScriptBin</code>, which does what you‚Äôd expect.</p>
<p>I have never heard of <code>bash -n</code>, but presumably it ‚Äúchecks its syntax.‚Äù Obligatory mention of <a href=https://www.shellcheck.net/><code>shellcheck</code></a>, one of the nobler things a human hand has wrought.</p>
<p><code>man bash</code> does not document <code>-n</code> as a flag, because it seems <code>-n</code> is short for <code>set -n</code> before the script. So if you‚Äôre curious what it does, you need to find the documentation for the <code>set</code> builtin.</p>
<p>How do you do that? I honestly don‚Äôt know the right answer. I do it by running <code>man bash</code> and then <code>/&nbsp;&nbsp;&nbsp;&nbsp;set</code>. Searching for ‚Äú<code>set</code>‚Äù gives thousands of results, but searching for ‚Äú<code>&nbsp;&nbsp;&nbsp;&nbsp;set</code>‚Äù only gives a few irrelevant results before you find the one you want.</p>
<p>I should really learn how to use <code>man</code> better. That <em>can‚Äôt</em> be the right way to find documentation, but it‚Äôs what I‚Äôve always done.</p>
<p>Also weird that we have two different shells mentioned in that script: <code>runtimeShell</code> and <code>stdenv.shell</code>. What‚Äôs <code>runtimeShell</code>? I am guessing this is a ‚Äúhost platform‚Äù vs ‚Äúbuild platform‚Äù distinction, but I‚Äôve never seen such a thing before.</p>
<p>It is not documented anywhere in the <code>nixpkgs</code> manual ‚Äì the only occurrence of the string <code>runtimeShell</code> is in a couple of code examples.</p>
<p>From our old friend <code>all-packages.nix</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1>### SHELLS</span>

<span class=n>runtimeShell</span> <span class=err>=</span> <span class=s2>"</span><span class=si>${</span><span class=n>runtimeShellPackage</span><span class=si>}${</span><span class=n>runtimeShellPackage</span><span class=o>.</span><span class=n>shellPath</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
<span class=n>runtimeShellPackage</span> <span class=err>=</span> <span class=n>bash</span><span class=p>;</span>
</code></pre></div><p>No explanation. No notes on when to use it. Just‚Ä¶ <code>SHELLS</code>.</p>
<p>Okay.</p>
<p>Anyway, next up we have <code>symlinkJoin</code>:</p>
<blockquote>
<p>This can be used to put many derivations into the same directory structure. It works by creating a new derivation and adding symlinks to each of the paths listed. It expects two arguments, <code>name</code>, and <code>paths</code>. <code>name</code> is the name used in the Nix store path for the created derivation. <code>paths</code> is a list of paths that will be symlinked. These paths can be to Nix store derivations or any other subdirectory contained within.</p>
</blockquote>
<p>Huh! Okay. Kinda neat. So I could have used that to <a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>declaratively create my own user environment</a>, if fate had not presented me the much simpler way.</p>
<p>Alright! I like these. These are good functions. But these are not the <em>only</em> functions in <code>trivial-builders.nix</code>. I already showed <code>writeShellScript</code>; here‚Äôs another fun one:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=c1># Create a C binary</span>
<span class=n>writeCBin</span> <span class=err>=</span> <span class=n>name</span><span class=p>:</span> <span class=n>code</span><span class=p>:</span>
  <span class=n>runCommandCC</span> <span class=n>name</span>
  <span class=p>{</span>
    <span class=k>inherit</span> <span class=n>name</span> <span class=n>code</span><span class=p>;</span>
    <span class=n>executable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
    <span class=n>passAsFile</span> <span class=o>=</span> <span class=p>[</span><span class=s2>"code"</span><span class=p>];</span>
    <span class=c1># Pointless to do this on a remote machine.</span>
    <span class=n>preferLocalBuild</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
    <span class=n>allowSubstitutes</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=s1>''
</span><span class=s1>  n=$out/bin/$name
</span><span class=s1>  mkdir -p "$(dirname "$n")"
</span><span class=s1>  mv "$codePath" code.c
</span><span class=s1>  $CC -x c code.c -o "$n"
</span><span class=s1>  ''</span><span class=p>;</span>
</code></pre></div><p>There‚Äôs another function called <code>linkFarm</code>, undocumented in the manual, which operates like <code>symlinkJoin</code>, but provides a different output structure.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/*
</span><span class=cm> * symlinkJoin is used to create a derivation with a familiar directory
</span><span class=cm> * structure (top-level bin/, share/, etc), but with all actual files being symlinks to
</span><span class=cm> * the files in the input derivations.
</span><span class=cm> *
</span><span class=cm> * symlinkJoin is used many places in nixpkgs to create a single derivation
</span><span class=cm> * that appears to contain binaries, libraries, documentation, etc from
</span><span class=cm> * multiple input derivations.
</span><span class=cm> *
</span><span class=cm> * linkFarm is instead used to create a simple derivation with symlinks to
</span><span class=cm> * other derivations.  A derivation created with linkFarm is often used in CI
</span><span class=cm> * as a easy way to build multiple derivations at once.
</span><span class=cm> */</span>
</code></pre></div><p>In other words, <code>linkFarm</code> does the trivial thing:</p>
<pre tabindex=0><code>/nix/store/qc5728m4sa344mbks99r3q05mymwm4rw-myexample
|-- foobar -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1
`-- hello-test -&gt; /nix/store/qy93dp4a3rqyn2mz63fbxjg228hffwyw-hello-2.10
</code></pre><p>And <code>symlinkJoin</code> does a merge:</p>
<pre tabindex=0><code>/nix/store/sglsr5g079a5235hy29da3mq3hv8sjmm-myexample
|-- bin
|   |-- hello -&gt; /nix/store/qy93dp4a3rqyn2mz63fbxjg228hffwyw-hello-2.10/bin/hello
|   `-- stack -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/bin/stack
`-- share
    |-- bash-completion
    |   `-- completions
    |       `-- stack -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/share/bash-completion/completions/stack
    |-- fish
    |   `-- vendor_completions.d
    |       `-- stack.fish -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/share/fish/vendor_completions.d/stack.fish
...
</code></pre><p>Neat. There are a few other functions in <code>trivial-builders</code> ‚Äì <code>applyPatches</code>, which is very rarely used, on account of the standard builder having first-class support for patching.</p>
<p><code>requireFile</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/* Print an error message if the file with the specified name and
</span><span class=cm> * hash doesn't exist in the Nix store. This function should only
</span><span class=cm> * be used by non-redistributable software with an unfree license
</span><span class=cm> * that we need to require the user to download manually. It produces
</span><span class=cm> * packages that cannot be built automatically.
</span></code></pre></div><p>These weirdos:</p>
<pre tabindex=0><code># Copy a path to the Nix store.
# Nix automatically copies files to the store before stringifying paths.
# If you need the store path of a file, ${copyPathToStore &lt;path&gt;} can be
# shortened to ${&lt;path&gt;}.
copyPathToStore = builtins.filterSource (p: t: true);

# Copy a list of paths to the Nix store.
copyPathsToStore = builtins.map copyPathToStore;
</code></pre><p><code>copyPathsToStore</code> is used in exactly one place, the <code>fetchRepoProject</code> function. The last chapter didn‚Äôt mention this, but it seems to exist to support <a href=https://gerrit.googlesource.com/git-repo><code>git-repo</code></a> projects, which I have never heard of. <code>fetchRepoProject</code> is used in exactly one place: the <code>amdvlk</code> package:</p>
<pre tabindex=0><code>$ sd nix info amdvlk
amdvlk-2021.Q2.2 AMD Open Source Driver For Vulkan
</code></pre><p>So, okay. Let‚Äôs stop talking about trivial builders now.</p>
<h1 id=chapter-13-special-buildershttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-special><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-special>Chapter 13. Special builders</a></h1>
<p>There are two special builders.</p>
<p>The first is <code>buildFHSUserEnv</code>. If you are not familiar with the acronym FHS, it stands for <a href=https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard>Filesystem Hierarchy Standard</a>. This is a convention that some Linuxes adhere to, and some packages expect. But NixOS does not adhere to this convention, and thus packages that expect it will probably be disappointed.</p>
<blockquote>
<p>It uses Linux namespaces feature to create temporary lightweight environments which are destroyed after all child processes exit, without root user rights requirement.</p>
</blockquote>
<p>Neat. And this is used in a lot of places! But I assume, based on that note, that it‚Äôs not going to work on my mac.</p>
<p>Looking through packages that use it, they all feel pretty‚Ä¶ heavy. <code>android-studio</code>. <code>steam</code>. <code>dropbox</code>. A bunch of stuff I‚Äôve never heard of. <code>foldingathome</code>! That seems like the sort of thing I would actually try to install with Nix, and that I know (because I just googled it) works in theory on macOS. Let‚Äôs give it a shot.</p>
<pre tabindex=0><code>$ nix-shell -p foldingathome
error: Package ‚Äòfahclient-7.6.13‚Äô in /nix/store/4rvsrjbd2f351zgdh38as0xzwrlmvzkm-nixpkgs-21.05pre287374.1c16013bd6e/nixpkgs/pkgs/applications/science/misc/foldingathome/client.nix:53 is not supported on ‚Äòx86_64-darwin‚Äô, refusing to evaluate.
</code></pre><p>So, exactly what I expected.</p>
<p>I‚Äôm not going to worry too much about <code>buildFHSUserEnv</code>. It‚Äôs neat to know it exists, but it‚Äôs not something I can really imagine myself using, so I will not bother to read through the usage in detail.</p>
<p>The next ‚Äúspecial builder‚Äù is far more interesting and useful. It‚Äôs called <code>mkShell</code>.</p>
<p>Now, I have not written anything about <code>mkShell</code> before. This is the first time it‚Äôs come up in the manual.</p>
<p>But I actually know about the function already.</p>
<p>I know about the function because, in addition to writing this incredibly long series of posts about the Nix documentation, I have actually been <em>using</em> Nix for the last couple of months as well.</p>
<p>But I haven‚Äôt been writing a blog post every time I did anything with Nix ‚Äì although I do mean to. I‚Äôve been keeping notes. And I‚Äôve tried to learn as little as possible ‚Äúoutside‚Äù this series. But I learned about <code>mkShell</code>, and I didn‚Äôt tell you, and I am sorry.</p>
<p>So here I will summarize what I know. In fact, I‚Äôll just quote my notes at you:</p>
<blockquote>
<p>On March 17 I tried to make a <code>nix-shell</code> for my <a href=https://ianthehenry.com/posts/drinking-with-datalog/>Drinking with Datalog</a> post.</p>
<p>I tried to write this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=n>souffle</span>
</code></pre></div><p>But of course that would give me the <em>dependencies</em> of <code>souffle</code>, not <code>souffle</code> itself. And I don‚Äôt know how to write a <code>shell.nix</code> equivalent of <code>nix-shell -p souffle</code>, so I just run that command every time and feel weird about it.</p>
<p>But eventually I google and find this page:</p>
<p><a href=https://nixos.wiki/wiki/Development_environment_with_nix-shell>https://nixos.wiki/wiki/Development_environment_with_nix-shell</a></p>
<p>Which got me this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=n>mkShell</span> <span class=p>{</span>
  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=p>[</span> <span class=n>souffle</span> <span class=p>];</span>
<span class=p>}</span>
</code></pre></div></blockquote>
<p>So now you‚Äôre caught up. You know as much as I do. I wanted to write a <code>shell.nix</code> file, and that‚Äôs how I did it. I didn‚Äôt read that whole wiki page, just skimmed and found the <code>mkShell</code> function.</p>
<p><em>Anyway</em>. Now the manual teaches it to me for the first time:</p>
<blockquote>
<p><code>pkgs.mkShell</code> is a special kind of derivation that is only useful when using it combined with <code>nix-shell</code>. It will in fact fail to instantiate when invoked with <code>nix-build</code>.</p>
</blockquote>
<p>I think this is <em>such a basic thing</em> that it should be a part of the Nix quick start guide. I think as soon as you introduce <code>nix-shell -p</code>, you gotta introduce <code>mkShell</code> right after it. It‚Äôs only right. Instead, this incredibly useful thing is hidden in this weird ‚ÄúSpecial Builders‚Äù chapter of the Nixpkgs manual. And I would bet pretty good money that no regular Nix user (as opposed to an aspiring Nixpkgs maintainer) has ever actually read this manual in such detail before.</p>
<p>Anyway; home stretch now.</p>
<h1 id=chapter-14-imageshttpswebarchiveorgweb20210318102415if_httpsnixosorgmanualnixpkgsstablechap-images><a href=https://web.archive.org/web/20210318102415if_/https://nixos.org/manual/nixpkgs/stable/#chap-images>Chapter 14. Images</a></h1>
<p>The manual describes support in Nixpkgs for <a href=https://appimage.org/>AppImage</a>, <a href=https://www.docker.com/>Docker</a>, <a href=https://github.com/opencontainers/runtime-spec>OCI</a>, and <a href=https://snapcraft.io/>Snap</a> images.</p>
<p>This is rather a long chapter, going into some detail about these different formats.</p>
<p>I have no interest in any of these formats, so I am going to quickly skim for the big picture.</p>
<p>So, AppImage: basically, if you want to put something in Nixpkgs, but it‚Äôs published as an AppImage container, you can just use some nice helper functions to wrap it up and turn it into a derivation.</p>
<p>Okay.</p>
<p>Docker: these appear to be helpers for <em>creating</em> Docker images, possibly out of other existing Docker images.</p>
<p>I consider myself very lucky that, at this point in my life, I have never had to use Docker or create a Docker image or really learn much at all about Docker, and I‚Äôm certainly not going to start now.</p>
<p>But it seems that Nixpkgs has <em>quite a lot of functions</em> if you are inclined to use them. I‚Äôm kind of surprised by the depth of support here: I would expect the intersection between people who like Nix and people who like Docker would be rather small. But I suppose many people are forced to use Docker through no fault of their own, and if you have to make a Docker image you may as well do it in a sort of declarative way.</p>
<p>Searching through Nixpkgs reveals that these functions are basically only used by the <code>kubernetes</code> package, but I imagine they are mostly used by people using Nix for private enterprises outside of Nixpkgs.</p>
<p>Anyway.</p>
<p>There is exactly one use of <code>ociTools</code> in Nixpkgs, in something called Railcar. Never heard of it. But again, I would expect this is more for Nix users to use for themselves.</p>
<p>Lastly Snap. Seems like functions to create Snapcraft‚Ä¶ snaps. Not Snapps? Some sort of cutesy GNU-like ‚ÄúSnapp‚Äôs Not APPS‚Äù?</p>
<p>I pay even less attention to this section, because I am very very confident that whatever the future has in store for me, it does not involve publishing software on Canonical‚Äôs ‚Äúapp store for Linux.‚Äù</p>
<p>Alright! And that‚Äôs the end.</p>
<p>We learned about the ‚Äúbuilders.‚Äù</p>
<p>Sort of. There are actually two more chapters in this section. But the next chapter is language-specific infrastructure, which is <em>definitely</em> its own post, and the one after that is about configuring specific complicated packages, which feels like a different concern than the simple ‚Äúbuilders‚Äù we‚Äôve seen so far.</p>
<p><em>Nowhere</em> in any of those chapters did the manual say something like ‚ÄúHey, <code>fetchurl</code> returns a derivation,‚Äù which is an insight that I find very important. Although I admit this is not really the <em>right</em> place to say that. It‚Äôs important enough information that it should be in the Nix manual, not buried in the Nixpkgs manual.</p>
<hr>
<ul>
<li>Do we need <code>fetchFromSavannah</code> here?</li>
<li>What does it mean to ‚Äúhave a builder for the <code>system</code>‚Äù of <code>runCommandLocal</code>?</li>
<li>Does <code>allowSubstitues = false</code> disable substitutes for all dependencies of a derivation as well?</li>
<li>What is <code>runtimeShell</code>, and when should I prefer it over <code>$SHELL</code>?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Builders%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Next up ‚ûú Languages and frameworks</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></strong>&nbsp;‚Üê&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
¬© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
