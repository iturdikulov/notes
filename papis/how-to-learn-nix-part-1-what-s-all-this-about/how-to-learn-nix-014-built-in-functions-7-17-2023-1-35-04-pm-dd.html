<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/ 
 saved date: Mon Jul 17 2023 13:35:04 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 14: Built-in Functions</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"ğŸŒ–"}#dmt:hover::before{content:"ğŸŒ—"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"ğŸŒ’"}:root:not(.light-theme) #dmt:hover::before{content:"ğŸŒ“"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}h1{font-size:130%}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr,main *+h1{margin-top:1em}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .cm{color:var(--palette-dim)}.highlight .c1{color:var(--palette-dim)}.highlight .nb{color:var(--palette-text)}.highlight .no{color:var(--palette-red)}.highlight .mi{color:var(--palette-orange)}.highlight .sd{color:var(--palette-dim)}.highlight .s2{color:var(--palette-green)}.highlight .sr{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 14: Built-in Functions">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>
<meta name=description content="Ooooookay. This is a really, really long section. This is likeâ€¦ a reference. Dang. Okay.">
<meta property=og:description content="Ooooookay. This is a really, really long section. This is likeâ€¦ a reference. Dang. Okay.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-03-12>March 12, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>How to Learn Nix, Part&nbsp;14:<br>Built-in Functions</a></h1>
</div>
<div class=post-content><p>Ooooookay. This is a really, really long section. This is likeâ€¦ a reference. Dang. Okay.</p>
<h1 id=155-built-in-functionshttpswebarchiveorgweb20210227145624httpsnixosorgmanualnixstablessec-builtins><a href=https://web.archive.org/web/20210227145624/https://nixos.org/manual/nix/stable/#ssec-builtins>15.5. Built-in Functions</a></h1>
<blockquote>
<p>Some built-ins, such as <code>derivation</code>, are always in scope of every Nix expression; you can just access them right away. But to prevent polluting the namespace too much, most built-ins are not in scope. Instead, you can access them through the <code>builtins</code> built-in value, which is a set that contains all built-in functions and values. For instance, <code>derivation</code> is also available as <code>builtins.derivation</code>.</p>
</blockquote>
<p>Okay. Itâ€™d be nice to start with the ones that <em>are</em> in scope by default, as they are likely to be the most common or useful functions. But the manual just lists them alphabetically. I skim the list, to try to find thoseâ€¦</p>
<pre tabindex=0><code>abort
baseNameOf
dirOf
fetchTarball
import
isNull
map
removeAttrs
throw
toString
</code></pre><p>Okay, not too many. Even without type signatures, the names are pretty self-explanatory.</p>
<p>Iâ€™m curious how <code>abort</code> and <code>throw</code> workâ€¦</p>
<p><code>throw</code> says:</p>
<blockquote>
<p>Throw an error message <code>s</code>. This usually aborts Nix expression evaluation, but in <code>nix-env -qa</code> and other commands that try to evaluate a set of derivations to get information about those derivations, a derivation that throws an error is silently skipped (which is not the case for <code>abort</code>).</p>
</blockquote>
<p>Ooookay. Donâ€™t totally get that â€“ what is â€œa derivation that throws an error?â€ What does that mean? Why would I ever use <code>throw</code> or <code>abort</code>? Just for debugging? I donâ€™t know.</p>
<p><code>toString</code> works on sets if they have an attribute called <code>__toString</code>. <code>toString</code> for booleans has the same behavior as the stringification of derivation attributes into environment variables â€“ the <code>"1"</code>/<code>""</code> thing. I wonder if they are identical, but donâ€™t bother to find out. There is nothing in the description of <code>toString</code> about derivations, for example.</p>
<p>Math stuff. List functions youâ€™d expect. String functions youâ€™d expect. Nothing weird here. Functions on â€œsets.â€ Bitwise operations, but I still have no idea what size numbers are in Nix.</p>
<p>Ah, <code>builtins.currentSystem</code>. So I donâ€™t need to rebuild Nix after allâ€¦</p>
<p>I learn that <code>fetchTarball</code> caches downloads in <code>~/.cache/nix/tarballs/</code>. Okay.</p>
<p>Thereâ€™s <code>fetchGit</code>, with all the arguments you would expect. But this <em>doesnâ€™t</em> take a hash? Even in the cases where you omit <code>ref</code>. That seems weird.</p>
<p>Okay, <code>filterSource</code> is the first function that I donâ€™t intuitively understand.</p>
<blockquote>
<p>This function allows you to copy sources into the Nix store while filtering certain files.</p>
</blockquote>
<p>Okaaay. So I can refer to, like, the path to a git repo, and it gives me a path back, but with stuff removed? I can use this to exclude the <code>.git</code> directory. Neat. How does thatâ€¦ work? Not explained.</p>
<p>Nix has a <code>foldl'</code> but no <code>foldl</code>. Ha. Oh Haskell, you rascal.</p>
<p>Another weird one: <code>builtins.functionArgs</code>:</p>
<blockquote>
<p>Return a set containing the names of the formal arguments expected by the function <code>f</code>. The value of each attribute is a Boolean denoting whether the corresponding argument has a default value. For instance, <code>functionArgs ({ x, y ? 123}: ...) = { x = false; y = true; }</code>.</p>
</blockquote>
<p>Weird. What if the argument isnâ€™t a set?</p>
<blockquote>
<p>â€œFormal argumentâ€ here refers to the attributes pattern-matched by the function. Plain lambdas are not included, e.g. <code>functionArgs (x: ...) = { }</code>.</p>
</blockquote>
<p>Gotcha.</p>
<p>We have <code>getEnv</code> to read environment variables, and a caveat to be careful with it. Makes sense.</p>
<p>Interestingly, there are functions like <code>isList</code> and <code>isFunction</code> but no <code>isSet</code>. Instead that function is called <code>isAttrs</code>. Sorta gross. Thereâ€™s also <code>isNull</code>, but it is deprecated in favor of <code>x == null</code>. This is a little weird to me â€“ itâ€™s kind of nice to be able to write like <code>builtins.all isNull [null null null]</code> instead of <code>builtins.all (x: x == null) [null null null]</code>. I assume Nix doesnâ€™t support operator sections because there has been no mention of it.</p>
<p>We got regexes! Regex stuff. Alright.</p>
<p>We can <code>parseDrvName</code>:</p>
<blockquote>
<pre><code>builtins.parseDrvName "nix-0.12pre12876" = { name = "nix"; version = "0.12pre12876"; }
</code></pre>
</blockquote>
<p>Okay. Seems to be using <code>Drv</code> as an abbreviation, and not to refer to the <code>.drv</code> files weâ€™ve seen? Cool cool.</p>
<p><code>builtins.path</code> is weird â€“ it seems that â€œpathsâ€ are <em>not</em> just â€œpathsâ€ but â€œpaths plus a little metadata,â€ and <code>builtins.path</code> allows me to return new paths with that metadata set. Okay. And it seems like thatâ€™s how <code>filterSource</code> works â€“ all paths have a <code>filter</code> function that is apparently run during the act of copying files into the store, and <code>filterSource</code> changes that while leaving all of the other fancy properties alone.</p>
<p><code>builtins.placeholder</code>:</p>
<blockquote>
<p>Return a placeholder string for the specified output that will be substituted by the corresponding output path at build time. Typical outputs would be <code>"out"</code>, <code>"bin"</code> or <code>"dev"</code>.</p>
</blockquote>
<p>So presumably:</p>
<pre><code>builtins.placeholder "foo" = "/nix/store/g2dwvn98qciaj087nf82xn99qidhv87m-my-hello-1.0-foo"
</code></pre>
<p>But I donâ€™t really understand how this works â€“ what if I try to call this function outside of a derivation? How doesâ€¦ what does that mean? Thereâ€™s no type signature; I must be misunderstanding what itâ€™s saying.</p>
<p>I wish we had gone over, like, how to evaluate Nix expressions before all this. It would be nice if I had a repl that I could use, but I donâ€™t know how to do that.</p>
<p>File system stuff: <code>builtins.pathExists</code>, <code>builtins.readDir</code>, <code>builtins.readFile</code>. And <code>builtins.toFile</code>! Thatâ€™s cool.</p>
<blockquote>
<p>Store the string <code>s</code> in a file in the Nix store and return its path.</p>
</blockquote>
<p>One day I hope to understand how side effects work in this â€œpureâ€ language. Is this likeâ€¦ is this another kind of derivation? I have no idea.</p>
<p>The manual has a nice example here of using this to â€œinlineâ€ a file:</p>
<blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>stdenv</span><span class=o>,</span> <span class=n>fetchurl</span><span class=o>,</span> <span class=n>perl</span> <span class=p>}:</span>

<span class=n>stdenv</span><span class=o>.</span><span class=n>mkDerivation</span> <span class=p>{</span>
  <span class=n>name</span> <span class=o>=</span> <span class=s2>"hello-2.1.1"</span><span class=p>;</span>

  <span class=n>builder</span> <span class=o>=</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>toFile</span> <span class=s2>"builder.sh"</span> <span class=s2>"
</span><span class=s2>    source $stdenv/setup
</span><span class=s2>
</span><span class=s2>    PATH=$perl/bin:$PATH
</span><span class=s2>
</span><span class=s2>    tar xvfz $src
</span><span class=s2>    cd hello-*
</span><span class=s2>    ./configure --prefix=$out
</span><span class=s2>    make
</span><span class=s2>    make install
</span><span class=s2>  "</span><span class=p>;</span>

  <span class=n>src</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span>
    <span class=n>url</span> <span class=o>=</span> <span class=sd>http://ftp.nluug.nl/pub/gnu/hello/hello-2.1.1.tar.gz</span><span class=p>;</span>
    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>"1md7jsfd8pa45z73bz1kszpp01yw6x5ljkjk2hx7wl800any6465"</span><span class=p>;</span>
  <span class=p>};</span>
  <span class=k>inherit</span> <span class=n>perl</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></blockquote>
<p>Neat.</p>
<p>We have <code>seq</code> and <code>deepSeq</code>, with definitions that areâ€¦ that you would have no hope of understanding if you did not already know what they did from Haskell.</p>
<p><code>builtins.toPath</code>:</p>
<blockquote>
<p>DEPRECATED. Use <code>/. + "/path"</code> to convert a string into an absolute path. For relative paths, use <code>./. + "/path"</code>.</p>
</blockquote>
<p>Is that really better than <code>toPath</code>?</p>
<p><code>toJSON</code>/<code>fromJSON</code>/<code>toXML</code>. No <code>fromXML</code>. Shocking.</p>
<p><code>builtins.trace e1 e2</code>:</p>
<blockquote>
<p>Evaluate <code>e1</code> and print its abstract syntax representation on standard error. Then return <code>e2</code>. This function is useful for debugging.</p>
</blockquote>
<p>Neat; thatâ€™s useful.</p>
<p><code>builtins.tryEval</code> shallowly evaluates expressions and tells you if they throw. But itâ€™s, you know, shallow, and needs to be combined with <code>deepseq</code> to do what youâ€™d expect it to. This isâ€¦ this is something that makes perfect sense to me, but I would need to write like a page of words to explain it, and I am tired. I feel like there is <em>very little</em> chance that normal humans ever needs to use <code>tryEval</code> or <code>seq</code> or <code>deepSeq</code>.</p>
<p>Huh; Iâ€™m actually curious about that.</p>
<p>I <code>rg tryEval</code> and do not find it used in any actual package files â€“ just in scripts and helpers. So it seems like something Nixpkgs maintainers need to think about, but not Nix package maintainers. Good. Similar for <code>deepSeq</code>. <code>seq</code> seems to get a fair bit of use, but I donâ€™t look into it any further.</p>
<p>That seems like a good place to stop. Itâ€™s good to look through and get a sense for whatâ€™s out there.</p>
<p>I wonder if this is exhaustive â€“ I still have not learned how to likeâ€¦ just evaluate arbitrary Nix expressions, without writing a package to do it. But it would be nice to be able to just dump <code>builtins</code> and see for myself whatâ€™s in there.</p>
<p><em>Sigh</em> fine. It looks like <code>nix repl</code> can do this. I fire it up.</p>
<pre tabindex=0><code>$ nix repl
Welcome to Nix version 2.3.10. Type :? for help.

nix-repl&gt; builtins
{ abort = Â«primopÂ»; add = Â«primopÂ»; addErrorContext = Â«primopÂ»; all = Â«primopÂ»; any = Â«primopÂ»; appendContext = Â«primopÂ»; attrNames = Â«primopÂ»; attrValues = Â«primopÂ»; baseNameOf = Â«primopÂ»; bitAnd = Â«primopÂ»; bitOr = Â«primopÂ»; bitXor = Â«primopÂ»; builtins = { ... }; catAttrs = Â«primopÂ»; compareVersions = Â«primopÂ»; concatLists = Â«primopÂ»; concatMap = Â«primopÂ»; concatStringsSep = Â«primopÂ»; currentSystem = "x86_64-darwin"; currentTime = 1615431925; deepSeq = Â«primopÂ»; derivation = Â«lambda @ /nix/store/q0z2kvkgrpvaipa87jl98qh7g5pym5fj-nix-2.3.10/share/nix/corepkgs/derivation.nix:4:1Â»; derivationStrict = Â«primopÂ»; dirOf = Â«primopÂ»; div = Â«primopÂ»; elem = Â«primopÂ»; elemAt = Â«primopÂ»; false = false; fetchGit = Â«primopÂ»; fetchMercurial = Â«primopÂ»; fetchTarball = Â«primopÂ»; fetchurl = Â«primopÂ»; filter = Â«primopÂ»; filterSource = Â«primopÂ»; findFile = Â«primopÂ»; foldl' = Â«primopÂ»; fromJSON = Â«primopÂ»; fromTOML = Â«primopÂ»; functionArgs = Â«primopÂ»; genList = Â«primopÂ»; genericClosure = Â«primopÂ»; getAttr = Â«primopÂ»; getContext = Â«primopÂ»; getEnv = Â«primopÂ»; hasAttr = Â«primopÂ»; hasContext = Â«primopÂ»; hashFile = Â«primopÂ»; hashString = Â«primopÂ»; head = Â«primopÂ»; import = Â«primop-appÂ»; intersectAttrs = Â«primopÂ»; isAttrs = Â«primopÂ»; isBool = Â«primopÂ»; isFloat = Â«primopÂ»; isFunction = Â«primopÂ»; isInt = Â«primopÂ»; isList = Â«primopÂ»; isNull = Â«primopÂ»; isPath = Â«primopÂ»; isString = Â«primopÂ»; langVersion = 5; length = Â«primopÂ»; lessThan = Â«primopÂ»; listToAttrs = Â«primopÂ»; map = Â«primopÂ»; mapAttrs = Â«primopÂ»; match = Â«primopÂ»; mul = Â«primopÂ»; nixPath = [ ... ]; nixVersion = "2.3.10"; null = null; parseDrvName = Â«primopÂ»; partition = Â«primopÂ»; path = Â«primopÂ»; pathExists = Â«primopÂ»; placeholder = Â«primopÂ»; readDir = Â«primopÂ»; readFile = Â«primopÂ»; removeAttrs = Â«primopÂ»; replaceStrings = Â«primopÂ»; scopedImport = Â«primopÂ»; seq = Â«primopÂ»; sort = Â«primopÂ»; split = Â«primopÂ»; splitVersion = Â«primopÂ»; storeDir = "/nix/store"; storePath = Â«primopÂ»; stringLength = Â«primopÂ»; sub = Â«primopÂ»; substring = Â«primopÂ»; tail = Â«primopÂ»; throw = Â«primopÂ»; toFile = Â«primopÂ»; toJSON = Â«primopÂ»; toPath = Â«primopÂ»; toString = Â«primopÂ»; toXML = Â«primopÂ»; trace = Â«primopÂ»; true = true; tryEval = Â«primopÂ»; typeOf = Â«primopÂ»; unsafeDiscardOutputDependency = Â«primopÂ»; unsafeDiscardStringContext = Â«primopÂ»; unsafeGetAttrPos = Â«primopÂ»; valueSize = Â«primopÂ»; }
</code></pre><p>My <code>builtins</code> has <code>105</code> things in it, many of which are not documented. Most of these stringify to <code>Â«primopÂ»</code> which I assume means â€œprimitive operation,â€ i.e. actual language builtins. But not all of them!</p>
<p>Letâ€™s look at just the things that are interesting â€“ Iâ€™ll filter out <code>primop</code>s that the manual already covered. And we are left with:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>addErrorContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>appendContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>catAttrs</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=nb>currentTime</span> <span class=err>=</span> <span class=mi>1614488750</span><span class=p>;</span> <span class=c1># this is real; i did not change this</span>
<span class=nb>derivation</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>lambda</span> <span class=o>@</span> <span class=sr>/nix/store/q0z2kvkgrpvaipa87jl98qh7g5pym5fj-nix-2.3.10/share/nix/corepkgs/derivation.nix</span><span class=p>:</span><span class=mi>4</span><span class=p>:</span><span class=mi>1</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>derivationStrict</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=no>false</span> <span class=err>=</span> <span class=no>false</span><span class=p>;</span>
<span class=n>fetchMercurial</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>findFile</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>fromTOML</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>genericClosure</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>getContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>hasContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>hashString</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>langVersion</span> <span class=err>=</span> <span class=mi>5</span><span class=p>;</span>
<span class=n>mapAttrs</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>nixPath</span> <span class=err>=</span> <span class=p>[</span> <span class=o>...</span> <span class=p>];</span>
<span class=n>nixVersion</span> <span class=err>=</span> <span class=s2>"2.3.10"</span><span class=p>;</span>
<span class=no>null</span> <span class=err>=</span> <span class=no>null</span><span class=p>;</span>
<span class=n>partition</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>scopedImport</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>storeDir</span> <span class=err>=</span> <span class=s2>"/nix/store"</span><span class=p>;</span>
<span class=n>storePath</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=no>true</span> <span class=err>=</span> <span class=no>true</span><span class=p>;</span>
<span class=n>unsafeDiscardOutputDependency</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>unsafeDiscardStringContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>unsafeGetAttrPos</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>valueSize</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
</code></pre></div><p>Kind of a surprising number of things! Some of these are pretty self explanatory. No idea what â€œcontextâ€ is, though. Some of these seem to be helpers that were just not added to the manual when they were added to the language. Or maybe these are deprecated, and thatâ€™s why they arenâ€™t documented? But other deprecated functions are documented. Maybe these are <em>more</em> deprecated. I donâ€™t know.</p>
<p>I narrow this down to the following list of â€œinterestingâ€ functions â€“ things that do not seem self explanatory.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=n>addErrorContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>appendContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=nb>derivation</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>lambda</span> <span class=o>@</span> <span class=sr>/nix/store/q0z2kvkgrpvaipa87jl98qh7g5pym5fj-nix-2.3.10/share/nix/corepkgs/derivation.nix</span><span class=p>:</span><span class=mi>4</span><span class=p>:</span><span class=mi>1</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>derivationStrict</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>findFile</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>genericClosure</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>getContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>hasContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>nixPath</span> <span class=err>=</span> <span class=p>[</span> <span class=o>...</span> <span class=p>];</span>
<span class=n>scopedImport</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>storePath</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>unsafeDiscardOutputDependency</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>unsafeDiscardStringContext</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>unsafeGetAttrPos</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
<span class=n>valueSize</span> <span class=err>=</span> <span class=err>Â«</span><span class=n>primop</span><span class=err>Â»</span><span class=p>;</span>
</code></pre></div><p>Obviously I know <code>derivation</code>, but the fact that itâ€™s a lambda and not a built-in is super interesting to me. I look in that file, and the comment explains:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=cm>/* This is the implementation of the â€˜derivationâ€™ builtin function.
</span><span class=cm>   It's actually a wrapper around the â€˜derivationStrictâ€™ primop. */</span>
</code></pre></div><p>Who puts fancy quotes in source code? Thatâ€™s crazy. Get outta here.</p>
<pre tabindex=0><code>nix-repl&gt; builtins.getContext {}
error: value is a set while a string was expected, at (string):1:1

nix-repl&gt; builtins.getContext ""
{ }

nix-repl&gt; builtins.getContext "hello"
{ }
</code></pre><p>Hmmm. No idea.</p>
<pre tabindex=0><code>nix-repl&gt; builtins.appendContext "hello"
Â«primop-appÂ»

nix-repl&gt; builtins.appendContext "hello" "context"
error: value is a string while a set was expected, at (string):1:1

nix-repl&gt; builtins.appendContext "hello" { context = "context"; }
error: Context key 'context' is not a store path, at 0x7fc1b3006f48
</code></pre><p>Okay; still no idea. I try <code>genericClosure</code>, and am able to follow the type errors long enough to get something that does nothing:</p>
<pre tabindex=0><code>nix-repl&gt; :p builtins.genericClosure { startSet = [{ key = "value"; }]; operator = (x: [x x]); }
[ { key = "value"; } ]
</code></pre><p>No idea. I give up on that one.</p>
<pre><code>nix-repl&gt; builtins.nixPath
[ { ... } { ... } ]

nix-repl&gt; :p builtins.nixPath
[ { path = "/Users/ian/.nix-defexpr/channels"; 
    prefix = ""; }
  { path = "/nix/store/q0z2kvkgrpvaipa87jl98qh7g5pym5fj-nix-2.3.10/share/nix/corepkgs";
    prefix = "nix"; } ]
</code></pre>
<p>(Formatting mine, so you wonâ€™t have to scroll as much.)</p>
<p>Okay. I was kind of expecting just a list of strings. That doesnâ€™t match my <code>NIX_PATH</code>. What is <code>prefix</code>? I have no idea.</p>
<pre tabindex=0><code>nix-repl&gt; builtins.valueSize 1
24

nix-repl&gt; builtins.valueSize true
24

nix-repl&gt; builtins.valueSize 1.5
24

nix-repl&gt; builtins.valueSize ""
25

nix-repl&gt; builtins.valueSize "a"
26

nix-repl&gt; builtins.valueSize {}
269296

nix-repl&gt; builtins.valueSize { a = 1; }
269296
</code></pre><p>Okay. I assume values have 16 bytes of header, and ints/floats are each 8 bytes, because those are nice round numbers. I assume strings are null-terminated. <code>269296</code> is a big ol' number. I do not worry further.</p>
<p>I canâ€™t figure out anything else. Hopefully those functions arenâ€™t too important?</p>
<hr>
<ul>
<li>Why doesnâ€™t <code>fetchGit</code> return a fixed-output derivation?</li>
<li>Does <code>toString</code> have the same behavior as Nixâ€™s stringification of derivation attributes?</li>
<li>What is <code>builtins.placeholder</code>?</li>
<li>What is â€œcontextâ€?</li>
<li>What do the <code>unsafe</code> functions do?</li>
<li>What is <code>scopedImport</code>?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22Built-in%20Functions%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Next up âœ Advanced Topics</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></strong>&nbsp;â†&nbsp;you are here</li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></li>
</ol>
</aside>
</main>
<footer>
Â© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
