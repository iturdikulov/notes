<!DOCTYPE html> <html lang=en style><!--
 Page saved with SingleFile 
 url: https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/ 
 saved date: Mon Jul 17 2023 13:35:16 GMT+0600 (Kyrgyzstan Time)
--><meta charset=utf-8>
<meta name=viewport content="initial-scale=1,maximum-scale=1">
<title>How to Learn Nix, Part 47: New and unimproved shells</title>
<link rel=canonical href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>
<style>:root{--box-radius:6px;--outer-box-radius:10px}:root{--content-bg:#fff;--gutter-bg:#eeeef3;--text-fg:#4d4d4c;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:#07c;--link-visited:#751a9a;--blockquote-accent:var(--link);--footnote-accent:#ffd2a3;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#34b553;--media-controls-contrast:#fff;--inline-code-bg:#f3f3fa;--code-block-bg:#f3f3fa;--aside-bg:#f3f3fa;--aside-warning-bg:#fff5d1;--aside-warning-fg:#ac3233;--palette-red:#c82829;--palette-green:#718c00;--palette-yellow:#eab700;--palette-orange:#f5871f;--palette-blue:#4271ae;--palette-purple:#8959a8;--palette-teal:#3e999f;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#8e908c;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--text-fg)}#dmt::before{content:"üåñ"}#dmt:hover::before{content:"üåó"}@media (prefers-color-scheme:dark){:root:not(.light-theme){--content-bg:#313233;--gutter-bg:#1d1f21;--text-fg:#d8d4cf;--table-border-color:#ccc;--separator-color:#6d6d6c;--link:rgb(82,183,255);--link-visited:rgb(193,104,229);--blockquote-accent:var(--link);--footnote-accent:#a8612f;--subscribe-button-bg:#44e66c;--subscribe-button-fg:#11391b;--media-controls-on:#44e66c;--media-controls-contrast:#11391b;--inline-code-bg:#3c4044;--code-block-bg:#1d1f21;--aside-bg:#3c4044;--aside-warning-bg:#fff5d1;--aside-warning-fg:var(--palette-red);--palette-red:#cc6666;--palette-green:#b5bd68;--palette-yellow:#f0c674;--palette-orange:#de935f;--palette-blue:#81a2be;--palette-purple:#b294bb;--palette-teal:#8abeb7;--palette-white:#fefefe;--palette-black:#000;--palette-text:var(--text-fg);--palette-dim:#969896;--highlight-bg:var(--palette-yellow);--highlight-fg:var(--palette-black)}:root:not(.light-theme) #dmt::before{content:"üåí"}:root:not(.light-theme) #dmt:hover::before{content:"üåì"}}#dmt{width:30px;text-align:right;padding-right:4px;position:absolute;top:0;bottom:0;right:0;border:none;background-color:inherit;cursor:pointer}*{margin:0;padding:0;font:inherit;box-sizing:border-box}html{background-color:var(--gutter-bg);color:var(--text-fg)}body{font-family:system-ui,sans-serif;font-size:12pt;line-height:1.8;word-wrap:break-word}body:not(.content-page) main>aside{padding:0 var(--content-padding)}body.content-page main,body:not(.content-page) article{background-color:var(--content-bg);border-radius:var(--outer-box-radius);padding:var(--content-padding)}pre{word-wrap:normal}em,i{font-style:italic}h1>a:only-child,h2>a:only-child{display:block}main .subsection-header+.post-list{margin-top:0}strong{font-weight:700}ol,ul{padding-left:3ch}hr{border-style:solid;border-width:1.5px 0 0;border-radius:1px;border-color:var(--separator-color)}:not(pre)>code{white-space:pre;background-color:var(--inline-code-bg)}li{padding-left:0}blockquote{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:"";content:none}a,a:active,a:visited{text-decoration:none}a:hover{text-decoration:underline}blockquote{padding:0 0 0 var(--content-padding);border-left:solid 2px var(--blockquote-accent)}aside{--content-padding:0.5em;padding:.5em;border-radius:var(--box-radius);background-color:var(--aside-bg)}a,a:active,header a:visited,footer a:visited,h1 a:visited{color:var(--link)}a:visited{color:var(--link-visited)}main *+p,main *+pre,main *+aside,main *+article,main *+blockquote,main *+div,main *+ul,main *+hr{margin-top:1em}main pre+div.highlight,main div.highlight+pre,main pre+pre{margin-top:1px}main .post-header *+h1{margin-top:0}code{font-family:Menlo,monospace;padding:0 3px;border-radius:2px}pre{background-color:var(--code-block-bg);font-size:11pt;padding:calc(.75*var(--content-padding)) var(--content-padding);line-height:1.3;border-radius:var(--box-radius);overflow-x:scroll;-webkit-overflow-scrolling:touch}pre code{padding:0;border-radius:0;display:inline-block;background-color:initial}p+p{margin-top:1em}body{margin:0 auto;--content-padding:10px;max-width:768px;-webkit-text-size-adjust:100%;position:relative}header{position:relative}header>*{height:48px;line-height:48px}.promo,.promo:visited,.promo:active{display:block;text-align:center;background-color:var(--link);color:var(--code-block-bg);border-radius:0 0 var(--outer-box-radius) var(--outer-box-radius)}header .site-title{font-size:130%}header nav{position:absolute;right:30px;top:0}@media all and (max-width:400px){:root{--outer-box-radius:0}header{text-align:center}header nav{position:static}:not(pre)>code{white-space:pre-wrap}body{--content-padding:10px}#dmt{padding:0;text-align:center;width:40px}}header ul{padding:0}header li{list-style:none;display:inline-block}header a{display:block;height:100%}header li+li{margin-left:1em}footer{padding:2em 0;font-size:.85em;text-align:center}article h1.post-title{font-size:200%}article .post-title a{display:block}article .meta{font-size:90%;font-style:italic}.post-header h1{line-height:1.2em;margin-bottom:.5em}.post-footer{text-align:center}.post-footer a{display:block}ol.post-list{list-style-position:inside;padding:0}.series-rider .series-name{font-style:italic}.highlight{color:var(--palette-text)}.highlight .err{color:var(--palette-red)}.highlight .k{color:var(--palette-purple)}.highlight .n{color:var(--palette-text)}.highlight .o{color:var(--palette-teal)}.highlight .p{color:var(--palette-text)}.highlight .c1{color:var(--palette-dim)}.highlight .kc{color:var(--palette-purple)}.highlight .kn{color:var(--palette-teal)}.highlight .nb{color:var(--palette-text)}.highlight .nt{color:var(--palette-teal)}.highlight .nv{color:var(--palette-red)}.highlight .mi{color:var(--palette-orange)}.highlight .s2{color:var(--palette-green)}.highlight .si{color:var(--palette-orange)}.highlight .sr{color:var(--palette-green)}.highlight .s1{color:var(--palette-green)}</style>
<meta property=og:title content="How to Learn Nix, Part 47: New and unimproved shells">
<meta property=og:type content=website>
<meta property=og:url content=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>
<meta name=description content="So a sort of crazy thing happened to the Nix UI between Nix 2.3 and 2.4.
nix shell, the command that opens a shell, was renamed to nix develop.
nix develop is not only more to type (no, nix dev does not work), but it‚Äôs also a‚Ä¶ misleading name for this command. I publish and preview my blog from a Nix shell, which has dependencies like my static site generator and CSS prefixer and such. I do not think of this as ‚Äúdeveloping‚Äù my blog. I think of it as writing my blog within a Nix shell. Shells are more broadly useful than ‚Äújust‚Äù software development, even if that is the main use case.">
<meta property=og:description content="So a sort of crazy thing happened to the Nix UI between Nix 2.3 and 2.4.
nix shell, the command that opens a shell, was renamed to nix develop.
nix develop is not only more to type (no, nix dev does not work), but it‚Äôs also a‚Ä¶ misleading name for this command. I publish and preview my blog from a Nix shell, which has dependencies like my static site generator and CSS prefixer and such. I do not think of this as ‚Äúdeveloping‚Äù my blog. I think of it as writing my blog within a Nix shell. Shells are more broadly useful than ‚Äújust‚Äù software development, even if that is the main use case.">
<meta property=og:image content=https://ianthehenry.com/checkerboard.png>
<meta name=twitter:creator content=@ianthehenry>
<meta name=twitter:card content=summary>
<link type=image/x-icon rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAHH1uIDShg/xEsZv8GFk3/CSJb/wgZT/8IGU//CBlP/wkiW/8HGE7/CBlP/wkiW/8HIFX/BxhO/wcgVf8OK2t7JDhz/wcfW/8NNn7/CSpq/wkjYf8MJGP/DCJg/w02ef9SqdX/TKHJ/1my2f9Moc3/UqzV/1Cr1v9Pocf/Ditr/xk2cf8KJGL/CjR8/wwva/8RK2r/Cido/w8qa/8LLW//TqjT/1Gnz/9bsNf/Sp/K/1Wt2f9Wrtj/UKjQ/w8xc/8gPHj/Di5w/xk4ef8TL27/Dy5u/xU3fv8QLGv/Ditr/1qy3f9dttv/Yrje/0ecx/9Knsz/U6fQ/1m13f8YN3n/JjZx/wszdv8YOXz/Eilm/xc3e/8dSZT/GDJz/xk/hv9hu+P/WbHZ/1mv1v9Kn8z/WLHd/1212v9ds9n/Eipr/xcqYv8SOX3/GzRz/xQrZ/8aM3D/HEuU/xc0df8fPYD/Yrre/1603P9dt9z/VKvY/1iz4v9etNr/Y73m/xk5fP8cMm3/JEWK/xc0dP8eO3v/Hjd4/ydRnP8WM3P/Gjd3/2bA5/9dtd//Ybng/2K95v9ct+P/Ybnf/2K95/8oS5L/GChg/xxBh/8lSIz/GC5s/yM5ev8hRoz/HTp7/yE6e/9Zsdz/YLzn/2jF7v9ryfL/YLzn/1qu1f9htdz/GDyD/y0/ev9qx/X/acDn/1235v9euun/Yb3r/1665v9owu7/GUOL/yhGh/8nUJL/MkmI/yBFiP8jOHb/MVag/yM+gv8VMGv/acXx/27G7/9szv3/bMb1/2zD6/9vy/X/edf5/yBHjv8yS47/JEuO/zVLiv8nS5D/LkOB/yRXpP8lQoT/H0WI/3fS+P910Pf/b8/8/2bB7/991Pn/eNb+/3nT+P8pS5L/O1GS/ytUnP86UJH/NF2k/zNLjP8sXKv/JkCB/x4+ff+B2/3/etT9/4He//922f//fNf//3TT//991/7/NU6N/zZSkP86Zav/PlWR/zFepv88ZKb/MF2n/yQ/gf8bNXH/fd3//3/b//+K6P//ft///3vV//993f//gdz//0hWlf9FZKX/RmOj/0JXlv9IeMP/QXKz/0Jsuf8eO3z/Hjt2/3vd//+C3v//ju3//3zg//+H4v//guL//4nj//9HXp3/UGur/ztgqf9JYqP/S3G4/05ur/9EbLT/Hjt7/zNJhf+G4///heT//4rq//+E5///iOT//4jr//+G4///UXO0/09iov9EX6H/SWWn/1V5wP9Kaa7/RGSp/ydLj/8NKGCfDShg/x8+d/8RLGb/CBlP/wYWTf8GFEj/CBNH/wooZP8JIlv/CCJd/woWSf8HGE7/ByBV/wwgU/8fO3mfAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=content-page>
<a class=promo href=https://janet.guide/ target=_blank><i>psst, hey kid, wanna read a weird programming book</i></a>
<header>
<a class=site-title href=https://ianthehenry.com/>Ian Henry</a>
<nav>
<ul><li><a href=https://ianthehenry.com/about/>About</a><li><a href=https://ianthehenry.com/posts/>Blog</a><li><a href=https://ianthehenry.com/stuff/>Stuff</a></ul>
</nav>
<button id=dmt title="Toggle dark mode"></button>
</header>
<main>
<aside class=series-rider>
<p>This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>, a rambling diary in which I work my way through the Nix manual in excrutiating detail.</p>
</aside>
<article class=post>
<div class=post-header>
<time class=meta datetime=2021-12-27>December 27, 2021</time>
<h1 class=post-title>
<a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>How to Learn Nix, Part&nbsp;47:<br>New and unimproved shells</a></h1>
</div>
<div class=post-content><p>So a sort of crazy thing happened to the Nix UI between Nix 2.3 and 2.4.</p>
<p><code>nix shell</code>, the command that opens a shell, was renamed to <code>nix develop</code>.</p>
<p><code>nix develop</code> is not only more to type (no, <code>nix dev</code> does not work), but it‚Äôs also a‚Ä¶ misleading name for this command. I publish and preview my blog from a Nix shell, which has dependencies like my static site generator and CSS prefixer and such. I do not think of this as ‚Äúdeveloping‚Äù my blog. I think of it as writing my blog within a Nix shell. Shells are more broadly useful than ‚Äújust‚Äù software development, even if that is the main use case.</p>
<p>Anyway. Coming from the classic commands: <code>nix-shell</code> is now called <code>nix develop</code>, and <code>nix-shell -p</code> is now called <code>nix shell</code>.</p>
<p>I don‚Äôt know why.</p>
<p>Maybe there‚Äôs some reason why <code>nix shell</code> and <code>nix develop</code> are separate now. It always made sense to me that <code>nix-shell -p</code> was just a specific, simple case of <code>nix-shell</code>, since they do <em>basically</em> the same thing. But maybe <code>nix develop</code> does something more? Something different? I don‚Äôt know.</p>
<p>Let‚Äôs find out.</p>
<p>In fact, let‚Äôs use this blog as an example. Its <code>shell.nix</code> looks like this:</p>
<pre><code>$ cat shell.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=n>mkShellNoCC</span> <span class=p>{</span>
  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>fswatch</span>
    <span class=n>hugo</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>autoprefixer</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>postcss-cli</span>
  <span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>One of the things I‚Äôm excited about with the new <code>nix shell</code> ‚Äì er, <code>nix develop</code> ‚Äì is dependency locking. I currently have <a href=https://github.com/ianthehenry/sd-nix/blob/f9c6f466c253f0a7aaf2aa63dc602f710811e9e6/shell>a janky little hand-rolled pinning scheme</a> for my blog, because <code>nodePackages.postcss-cli</code> broke at some point in the past and I haven‚Äôt had time to look into why. So I keep this pinned to the last known good revision of Nixpkgs.</p>
<p>It basically just runs:</p>
<pre tabindex=0><code>$ nix-shell -I nixpkgs=https://api.github.com/repos/NixOS/nixpkgs/tarball/fc39a32aa1322d8eec8f7224261c005cbf33954
</code></pre><p>Er, except that it also does <a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>the fancy garbage collection dance</a> that I‚Äôve talked about earlier. Which is another thing that <code>nix develop</code> can do automatically, <em>or so I‚Äôve heard</em>. Let‚Äôs try it out.</p>
<p>How do I migrate a <code>shell.nix</code> file to a flake?</p>
<p>Let‚Äôs start with the obvious one:</p>
<pre tabindex=0><code>$ nix develop
error: path '/Users/ian/src/ianthehenry.com' is not a flake (because it doesn't contain a 'flake.nix' file)
</code></pre><p>Alas. That is what I expected, but there was a small chance that <code>nix develop</code> was backwards compatible.</p>
<p>So let‚Äôs learn how to write the equivalent <code>flake.nix</code> file. I expect I should be able to import my <code>shell.nix</code> file from a <code>flake.nix</code> file‚Ä¶?</p>
<p>Let‚Äôs start by reading <code>nix develop --help</code>:</p>
<blockquote>
<p><code>nix develop</code> - run a <code>bash</code> shell that provides the build environment of a derivation</p>
</blockquote>
<p>Oh gosh oh no. That documentation is not promising. I expected that I would have to rediscover how to run <code>zsh</code>, but‚Ä¶ well, if it‚Äôs not possible, I guess I‚Äôm sticking with <code>nix-shell</code>.</p>
<p>Let‚Äôs see‚Ä¶ it shows some usage commands. It shows this:</p>
<blockquote>
<ul>
<li>Record a build environment in a profile:</li>
</ul>
<pre tabindex=0><code># nix develop --profile /tmp/my-build-env nixpkgs#hello
</code></pre></blockquote>
<p>Presumably that‚Äôs how I save things from the garbage collector. I‚Äôll have to come back to that.</p>
<blockquote>
<ul>
<li>Replace all occurences of the store path corresponding to <code>glibc.dev</code> with a writable directory:</li>
</ul>
<pre tabindex=0><code># nix develop --redirect nixpkgs#glibc.dev ~/my-glibc/outputs/dev
</code></pre><p>Note that this is useful if you‚Äôre running a <code>nix develop</code> shell for <code>nixpkgs#glibc</code> in <code>~/my-glibc</code> and want to compile another package against it.</p>
</blockquote>
<p>Whoa. Weird. Okay. I‚Äôll have to come back to that too.</p>
<p>Then it describes some stuff about the shell environment; okay‚Ä¶</p>
<blockquote>
<p><code>nix develop</code> starts a <code>bash</code> shell that provides an interactive build environment nearly identical to what Nix would use to build installable. Inside this shell, environment variables and shell functions are set up so that you can interactively and incrementally build your package.</p>
<p>Nix determines the build environment by building a modified version of the derivation installable that just records the environment initialised by <code>stdenv</code> and exits. This build environment can be recorded into a profile using <code>--profile</code>.</p>
</blockquote>
<p>Sounds a bit like the <code>inputDerivation</code> scheme that I use. I wonder how this works if you aren‚Äôt using <code>stdenv</code>?</p>
<blockquote>
<p>The prompt used by the <code>bash</code> shell can be customised by setting the <code>bash-prompt</code> and <code>bash-prompt-suffix</code> settings in <code>nix.conf</code> or in the flake‚Äôs <code>nixConfig</code> attribute.</p>
</blockquote>
<p><em>Not encouraging</em> for <code>zsh</code> users. Which is, you may recall, the default login shell for macOS users as of Catalina ‚Äì which came out in October 2019.</p>
<p>Alright. So now it talks about what it actually does:</p>
<blockquote>
<p>If no flake output attribute is given, <code>nix develop</code> tries the following flake output attributes:</p>
<ul>
<li><code>devShell.&lt;system&gt;</code></li>
<li><code>defaultPackage.&lt;system&gt;</code></li>
</ul>
<p>If a flake output name is given, <code>nix develop</code> tries the following flake output attributes:</p>
<ul>
<li><code>devShells.&lt;system&gt;.&lt;name&gt;</code></li>
<li><code>packages.&lt;system&gt;.&lt;name&gt;</code></li>
</ul>
</blockquote>
<p>Okay. Well. Let‚Äôs try this:</p>
<pre><code>$ cat shell.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>nixpkgs</span> <span class=o>?</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{}</span> <span class=p>}:</span>
<span class=k>with</span> <span class=n>nixpkgs</span><span class=p>;</span> <span class=n>mkShellNoCC</span> <span class=p>{</span>
  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>fswatch</span>
    <span class=n>hugo</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>autoprefixer</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>postcss-cli</span>
  <span class=p>];</span>
<span class=p>}</span>
</code></pre></div><pre><code>$ cat flake.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>devShell</span><span class=o>.</span><span class=si>${</span><span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span><span class=si>}</span> <span class=o>=</span>
      <span class=kn>import</span> <span class=sr>./shell.nix</span> <span class=p>{</span> <span class=k>inherit</span> <span class=n>nixpkgs</span> <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
error: source tree referenced by 'git+file:///Users/ian/src/ianthehenry.com' does not contain a '/flake.nix' file
</code></pre><p>Ah. Sigh. Because this is a Git repository, it‚Äôs assuming that I mean to treat it like a Git repository, and it‚Äôs upset that I haven‚Äôt added <code>flake.nix</code> yet? But I just want it to be a local path:</p>
<pre tabindex=0><code>$ time nix develop path:.
copying '/Users/ian/src/ianthehenry.com'
error: syntax error, unexpected '}'

       at /nix/store/7nk5xzhpmfq6g5ldzwf4cf1433pndhb6-source/flake.nix:4:44:

            3|     devShell.${builtins.currentSystem} =
            4|       import ./shell.nix { inherit nixpkgs };
             |                                            ^
            5|   };
1.34s user 2.18s system 83% cpu 4.198 total
</code></pre><p>Okay, no, because it spends 4 seconds copying this folder for some reason.</p>
<pre tabindex=0><code>$ git add flake.nix

$ time nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
error: syntax error, unexpected '}'

       at /nix/store/58r3rydwwni2mym0bnwjx1i9x8snpcmn-source/flake.nix:4:44:

            3|     devShell.${builtins.currentSystem} =
            4|       import ./shell.nix { inherit nixpkgs };
             |                                            ^
            5|   };
0.25s user 0.15s system 84% cpu 0.480 total
</code></pre><p>That‚Äôs better. And we can see that, <em>as always</em>, I forgot a semicolon on a singleton attribute set‚Ä¶</p>
<p>I fix that, and try again:</p>
<pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
warning: creating lock file '/Users/ian/src/ianthehenry.com/flake.lock'
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
error: 'outputs' at /nix/store/rawzl90y6d1mvk8qcfqshk5x6j0gvx9b-source/flake.nix:2:13 called with unexpected argument 'self'

       at ¬´string¬ª:45:21:

           44|
           45|           outputs = flake.outputs (inputs // { self = result; });
             |                     ^
           46|
</code></pre><p>Okay. I forgot how flakes work. Let‚Äôs try that again:</p>
<pre><code>$ cat flake.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>devShell</span><span class=o>.</span><span class=si>${</span><span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span><span class=si>}</span> <span class=o>=</span>
      <span class=kn>import</span> <span class=sr>./shell.nix</span> <span class=p>{</span> <span class=k>inherit</span> <span class=n>nixpkgs</span><span class=p>;</span> <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>Better?</p>
<pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
error: attribute 'currentSystem' missing

       at /nix/store/k5vy4d9l72isk2mbqw0slbc4hbcj0q0n-source/flake.nix:3:16:

            2|   outputs = { self, nixpkgs }: {
            3|     devShell.${builtins.currentSystem} =
             |                ^
            4|       import ./shell.nix { inherit nixpkgs; };
</code></pre><p>Ugh. Obviously <code>builtins.currentSystem</code> <em>does</em> exist, normally, but apparently it‚Äôs forbidden when evaluating a flake? Just to be annoying? So I have to actually type out <code>x86_64-darwin</code>. Which is like a Mavis Beacon boss level. One more try:</p>
<pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
error: undefined variable 'mkShellNoCC'

       at /nix/store/w1m5vcxihca30mj0wm1yyijl0lqzcmv6-source/shell.nix:2:15:

            1| { nixpkgs ? import &lt;nixpkgs&gt; {} }:
            2| with nixpkgs; mkShellNoCC {
             |               ^
            3|   nativeBuildInputs = [
</code></pre><p>Ah, okay, right, because <code>nixpkgs</code> is a flake now, not an attribute set. I have to do‚Ä¶</p>
<pre><code>$ cat flake.nix
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=p>{</span>
  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span> <span class=p>}:</span> <span class=p>{</span>
    <span class=n>devShell</span><span class=o>.</span><span class=n>x86_64-darwin</span> <span class=o>=</span>
      <span class=kn>import</span> <span class=sr>./shell.nix</span> <span class=p>{</span>
        <span class=n>nixpkgs</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>legacyPackages</span><span class=o>.</span><span class=n>x86_64-darwin</span><span class=p>;</span> 
      <span class=p>};</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div><p>And I finally got it:</p>
<pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
[0/5 built, 1/2/14 copied (19.8/177.0 MiB), 5.5/51.5 MiB DL] fetching hugo-0.90.0 from https://cac
</code></pre><p>Whoooo. I don‚Äôt know where it was copying from, because the Nix CLI once again assumes that my terminal spans the full length of a widescreen monitor, and it chops off at my paltry 98 columns.</p>
<pre tabindex=0><code>Ians-MBP:ianthehenry.com ian$ hugo version
hugo v0.90.0+extended darwin/amd64 BuildDate=unknown
</code></pre><p>But it did drop me into a bash shell! Wow. <code>Ians-MBP</code>. Is that the name of this computer? This poor computer. It deserves something a little more personalized. I honestly don‚Äôt know what that string is or how I would change it, though. And hopefully I will never see it again, so I choose to ignore it.</p>
<p>Okay. I eventually wrote a flake. I only had to type <code>x86_64-darwin</code> twice to do it, and my fingers are only barely cramping from the effort.</p>
<p><code>nix develop</code> did in fact ignore my <a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/><code>NIX_BUILD_SHELL</code> that I‚Äôve set to run <code>zsh</code></a>, so I once again find myself plunged into a land free from tab completion and shell aliases. Wonderful.</p>
<p>Now let‚Äôs lock it to the correct version‚Ä¶ <code>nix flake lock --help</code> gets me here:</p>
<pre tabindex=0><code>$ nix flake lock --update-input nixpkgs --override-flake nixpkgs https://api.github.com/repos/NixOS/nixpkgs/tarball/fc39a32aa1322d8eec8f7224261c005cbf339549
error: input 'https://api.github.com/repos/NixOS/nixpkgs/tarball/fc39a32aa1322d8eec8f7224261c005cbf339549' is unsupported
</code></pre><p>Er, darn. That‚Äôs the URL I was using before. But I guess the flaky version is:</p>
<pre tabindex=0><code>$ nix flake lock --update-input nixpkgs --override-flake nixpkgs github:nixos/nixpkgs/fc39a32aa1322d8eec8f7224261c005cbf339549
[24.7 MiB DL] downloading 'https://api.github.com/repos/nixos/nixpkgs/tarball/fc39a32aa1322d8eec8f
</code></pre><p>Nice. It‚Äôs downloading something and spending the traditional full minute unpacking or copying or whatever it‚Äôs doing with it. I expected that it would just‚Ä¶ update the lock file for me. But nope, it‚Äôs also gotta download and cache this. I dunno.</p>
<pre tabindex=0><code>$ nix flake lock --update-input nixpkgs --override-flake nixpkgs github:nixos/nixpkgs/fc39a32aa1322d8eec8f7224261c005cbf339549
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
warning: updating lock file '/Users/ian/src/ianthehenry.com/flake.lock':
‚Ä¢ Updated input 'nixpkgs':
    'github:NixOS/nixpkgs/2beba9a23a8381eb95187f46b10c3677d8f63ca1' (2021-12-19)
  ‚Üí 'github:nixos/nixpkgs/fc39a32aa1322d8eec8f7224261c005cbf339549' (2021-10-01)
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
</code></pre><p>Hey, that‚Äôs neat! I love that it shows the date.</p>
<p>I don‚Äôt know why it keeps telling me that my Git tree is dirty. I don‚Äôt know what I would possibly do with that information. I <em>know</em> that my worktree is dirty. You don‚Äôt have to tell me, twice, in the same command.</p>
<p>Let‚Äôs take a look:</p>
<pre><code>$ cat flake.lock
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"nodes"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"nixpkgs"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"locked"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"lastModified"</span><span class=p>:</span> <span class=mi>1633070184</span><span class=p>,</span>
        <span class=nt>"narHash"</span><span class=p>:</span> <span class=s2>"sha256-B0G23rPFBhiBsM/OU7WsFXL2dDaLdgRUU7onC/CCyiA="</span><span class=p>,</span>
        <span class=nt>"owner"</span><span class=p>:</span> <span class=s2>"nixos"</span><span class=p>,</span>
        <span class=nt>"repo"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"rev"</span><span class=p>:</span> <span class=s2>"fc39a32aa1322d8eec8f7224261c005cbf339549"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"github"</span>
      <span class=p>},</span>
      <span class=nt>"original"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"id"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span><span class=p>,</span>
        <span class=nt>"type"</span><span class=p>:</span> <span class=s2>"indirect"</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>"root"</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>"inputs"</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>"nixpkgs"</span><span class=p>:</span> <span class=s2>"nixpkgs"</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>},</span>
  <span class=nt>"root"</span><span class=p>:</span> <span class=s2>"root"</span><span class=p>,</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>7</span>
<span class=p>}</span>
</code></pre></div><p>Okay, neat. Looks great. It did the thing. And now:</p>
<pre tabindex=0><code>$ nix develop
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty

Ians-MBP:ianthehenry.com ian$ hugo version
hugo v0.88.1+extended darwin/amd64 BuildDate=unknown
</code></pre><p>So it worked! Nice.</p>
<p>And now let‚Äôs try the profile thingy‚Ä¶</p>
<pre tabindex=0><code>$ nix develop --profile ~/scratch/test-profile
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
Ians-MBP:ianthehenry.com ian$
</code></pre><p>Okay. Did that do anything?</p>
<pre tabindex=0><code>$ nix profile list --profile ~/scratch/test-profile
</code></pre><p>Umm‚Ä¶ no. It did not do anything, in fact. Did I‚Ä¶ do something wrong?</p>
<p>The example from the <code>--help</code> is:</p>
<blockquote>
<ul>
<li>Record a build environment in a profile:</li>
</ul>
<pre tabindex=0><code># nix develop --profile /tmp/my-build-env nixpkgs#hello
</code></pre></blockquote>
<p>Let‚Äôs try exactly that, minus the <code>sudo</code>‚Ä¶</p>
<pre tabindex=0><code>$ nix develop --profile /tmp/my-build-env nixpkgs#hello
zsh: no matches found: nixpkgs#hello
</code></pre><p>Sigh. Of course.</p>
<pre tabindex=0><code>$ nix develop --profile /tmp/my-build-env 'nixpkgs#hello'
Ians-MBP:ianthehenry.com ian$
</code></pre><p>Did <em>that</em> do anything?</p>
<pre tabindex=0><code>$ ll /tmp/my-build-env
/tmp/my-build-env -&gt; my-build-env-1-link

$ ll /tmp/my-build-env-1-link
/tmp/my-build-env-1-link -&gt; /nix/store/2cxr6dr0vpihcidc1b3h0vp0xvzxf8v4-hello-2.10-env

$ ll /nix/store/2cxr6dr0vpihcidc1b3h0vp0xvzxf8v4-hello-2.10-env
56K /nix/store/2cxr6dr0vpihcidc1b3h0vp0xvzxf8v4-hello-2.10-env
</code></pre><p>Okay. It produced a <em>56 kilobyte</em> file. It seems to contain‚Ä¶ all of the stdenv? I guess? Like the source code of the <code>stdenv/setup</code> script? The file looks like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"bashFunctions"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"_activatePkgs"</span><span class=p>:</span><span class=s2>" \n    local hostOffset targetOffset;\n    local pkg;\n    for hostOffset in \"${allPlatOffsets[@]}\";\n    do\n        local pkgsVar=\"${pkgAccumVarVars[hostOffset + 1]}\";\n        for targetOffset in \"${allPlatOffsets[@]}\";\n        do\n            (( hostOffset &lt;= targetOffset )) || continue;\n            local pkgsRef=\"${pkgsVar}[$targetOffset - $hostOffset]\";\n            local pkgsSlice=\"${!pkgsRef}[@]\";\n            for pkg in ${!pkgsSlice+\"${!pkgsSlice}\"};\n            do\n                activatePackage \"$pkg\" \"$hostOffset\" \"$targetOffset\";\n            done;\n        done;\n    done\n"</span><span class=p>,</span>
    <span class=nt>"_addRpathPrefix"</span><span class=p>:</span><span class=s2>" \n    if [ \"${NIX_NO_SELF_RPATH:-0}\" != 1 ]; then\n        export NIX_LDFLAGS=\"-rpath $1/lib ${NIX_LDFLAGS-}\";\n        if [ -n \"${NIX_LIB64_IN_SELF_RPATH:-}\" ]; then\n            export NIX_LDFLAGS=\"-rpath $1/lib64 ${NIX_LDFLAGS-}\";\n        fi;\n        if [ -n \"${NIX_LIB32_IN_SELF_RPATH:-}\" ]; then\n            export NIX_LDFLAGS=\"-rpath $1/lib32 ${NIX_LDFLAGS-}\";\n        fi;\n    fi\n"</span><span class=p>,</span>
    <span class=err>...</span> <span class=err>dozens</span> <span class=err>more</span> <span class=err>bash</span> <span class=err>functions</span> <span class=err>...</span>
  <span class=p>},</span>
  <span class=nt>"variables"</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>"AR"</span><span class=p>:</span> <span class=p>{</span><span class=nt>"type"</span><span class=p>:</span> <span class=s2>"exported"</span><span class=p>,</span> <span class=nt>"value"</span><span class=p>:</span> <span class=s2>"ar"</span><span class=p>},</span>
    <span class=nt>"AS"</span><span class=p>:</span> <span class=p>{</span><span class=nt>"type"</span><span class=p>:</span> <span class=s2>"exported"</span><span class=p>,</span> <span class=nt>"value"</span><span class=p>:</span> <span class=s2>"as"</span><span class=p>},</span>
    <span class=nt>"BASH"</span><span class=p>:</span> <span class=p>{</span><span class=nt>"type"</span><span class=p>:</span> <span class=s2>"var"</span><span class=p>,</span> <span class=nt>"value"</span><span class=p>:</span> <span class=s2>"/nix/store/3npg6a8nc5vpcyw98v085cmlz7f78kgs-bash-5.1-p12/bin/bash"</span><span class=p>},</span>
    <span class=nt>"BASHOPTS"</span><span class=p>:</span> <span class=p>{</span><span class=nt>"type"</span><span class=p>:</span> <span class=s2>"unknown"</span><span class=p>},</span>
    <span class=err>...</span> <span class=err>dozens</span> <span class=err>more</span> <span class=err>environment</span> <span class=err>variables</span> <span class=err>...</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>I have no idea. I mean, it created a <em>thing</em>. And when I manually inspect my <code>~/scratch/test-profile</code>, I can see that it is also a symlink to a thing that is kind of like this. But‚Ä¶ that‚Äôs not what a profile is‚Ä¶?</p>
<pre tabindex=0><code>$ nix profile install 'nixpkgs#hello' --profile ~/scratch/test-profile

$ nix profile list --profile ~/scratch/test-profile
0 flake:nixpkgs#legacyPackages.x86_64-darwin.hello github:NixOS/nixpkgs/2beba9a23a8381eb95187f46b10c3677d8f63ca1#legacyPackages.x86_64-darwin.hello /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10
</code></pre><p>Okay. So theoretically now this profile contains <code>nixpkgs#hello</code> <em>and</em> my weird shell thing?</p>
<pre tabindex=0><code>$ tree ~/scratch/test-profile
/Users/ian/scratch/test-profile
‚îú‚îÄ‚îÄ bin -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/bin
‚îú‚îÄ‚îÄ manifest.json
‚îî‚îÄ‚îÄ share -&gt; /nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10/share
</code></pre><pre><code>$ jq . /nix/store/s5ms489y3rsxbf8qijrqixc2qzyw8py2-profile/manifest.json
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>"elements"</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>"active"</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
      <span class=nt>"attrPath"</span><span class=p>:</span> <span class=s2>"legacyPackages.x86_64-darwin.hello"</span><span class=p>,</span>
      <span class=nt>"originalUri"</span><span class=p>:</span> <span class=s2>"flake:nixpkgs"</span><span class=p>,</span>
      <span class=nt>"storePaths"</span><span class=p>:</span> <span class=p>[</span>
        <span class=s2>"/nix/store/6sv1isax4axkxfnmg4gxg1pzr4417r6v-hello-2.10"</span>
      <span class=p>],</span>
      <span class=nt>"uri"</span><span class=p>:</span> <span class=s2>"github:NixOS/nixpkgs/2beba9a23a8381eb95187f46b10c3677d8f63ca1"</span>
    <span class=p>}</span>
  <span class=p>],</span>
  <span class=nt>"version"</span><span class=p>:</span> <span class=mi>1</span>
<span class=p>}</span>
</code></pre></div><p>Nope! Running <code>nix profile</code> blew away whatever <code>nix develop --profile</code> was doing. I guess‚Ä¶ those are like‚Ä¶ supposed to be separate‚Ä¶? Or‚Ä¶ what?</p>
<p>I don‚Äôt know.</p>
<p><em>Bizarre</em>.</p>
<p>I had suspected that this ‚Äúadding <code>devShells</code> to profiles‚Äù was one of the reasons that <code>nix profile list</code> output was so crazy. Because your profile doesn‚Äôt just consist of simple outputs-of-flakes anymore, instead they consist of these weird computed expressions.</p>
<p>But I guess‚Ä¶ that was wrong.</p>
<p>So I suppose the intended usage here, to prevent shells from being garbage-collected, is to like‚Ä¶?</p>
<pre tabindex=0><code>$ nix develop --profile ~/scratch/my-dev-profile

$ ln -s ~/scratch/my-dev-profile /nix/var/nix/gcroots/per-user/ian/my-dev-profile
</code></pre><p>Make a separate ‚Äúprofile‚Äù for each ‚Äú<code>devShell</code>‚Äù and manually add them as gcroots‚Ä¶?</p>
<p>This is, once again, not exactly the API I was hoping for. But perhaps I can wrap this into something friendly.</p>
<p>All of this is moot, of course, if I can‚Äôt get <code>nix develop</code> to run <code>zsh</code>. So let‚Äôs try that now‚Ä¶</p>
<p>There‚Äôs nothing in <code>nix develop --help</code> about changing the shell.</p>
<p><code>nix --help</code> teaches me <code>nix print-dev-env</code>. It says:</p>
<blockquote>
<p>print shell code that can be sourced by <code>bash</code> to reproduce the build environment of a derivation</p>
</blockquote>
<p>Which‚Ä¶ yep.</p>
<pre><code>$ nix print-dev-env
</code></pre>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>unset</span> shellHook
<span class=nv>nix_saved_PATH</span><span class=o>=</span><span class=s2>"</span><span class=nv>$PATH</span><span class=s2>"</span>
<span class=nv>BASH</span><span class=o>=</span><span class=s1>'/nix/store/lr6i6xpcmy46bd75gzziwbviy1pl4gq9-bash-5.1-p8/bin/bash'</span>
<span class=nv>CONFIG_SHELL</span><span class=o>=</span><span class=s1>'/nix/store/lr6i6xpcmy46bd75gzziwbviy1pl4gq9-bash-5.1-p8/bin/bash'</span>
<span class=nb>export</span> CONFIG_SHELL
<span class=nv>EPOCHREALTIME</span><span class=o>=</span><span class=s1>'1640635264.449310'</span>
<span class=nv>EPOCHSECONDS</span><span class=o>=</span><span class=s1>'1640635264'</span>
<span class=nv>HOSTTYPE</span><span class=o>=</span><span class=s1>'x86_64'</span>
<span class=nv>HOST_PATH</span><span class=o>=</span><span class=s1>'/nix/store/yf7fdgv8lad2xwxh579lk607sy09kzph-coreutils-8.32/bin:/nix/store/3z69mjjcq29jg8j64msxd16nw5pi8r1g-findutils-4.8.0/bin:/nix/store/l1gbwf4qcmiryiw7phjq9ida65k73akk-diffutils-3.8/bin:/nix/store/s86czlnc3dcfng4gzi1jvlg2zy92nih8-gnused-4.8/bin:/nix/store/356m58q4iqyd33px2k10rn0x4c85dszj-gnugrep-3.6/bin:/nix/store/gvvl9z2aq6wc0x8jcxpva1x3m3fy095d-gawk-5.1.0/bin:/nix/store/5qxxdkq73kg2i3vi8fxb09ifz3g1ardp-gnutar-1.34/bin:/nix/store/w1hhgcgjrnaq2wnm6nx8s2h4ddqzaa1s-gzip-1.10/bin:/nix/store/lvn1gbp8v47vp78splg7v99zyjvp249q-bzip2-1.0.6.0.2-bin/bin:/nix/store/2jfpbzvma5j6pkjk6g0lv8dk38cpdws5-gnumake-4.3/bin:/nix/store/lr6i6xpcmy46bd75gzziwbviy1pl4gq9-bash-5.1-p8/bin:/nix/store/v9ihxmjwilqmgnqwndz60zq1zlwnjvg6-patch-2.7.6/bin:/nix/store/m0jph60y81z6rp53xg5lvsvsqxy797fx-xz-5.2.5-bin/bin'</span>
<span class=nb>export</span> HOST_PATH

<span class=c1># ...dozens of lines of environment variables...</span>

_activatePkgs <span class=o>()</span>
<span class=o>{</span>
 
    <span class=nb>local</span> hostOffset targetOffset<span class=p>;</span>
    <span class=nb>local</span> pkg<span class=p>;</span>
    <span class=k>for</span> hostOffset in <span class=s2>"</span><span class=si>${</span><span class=nv>allPlatOffsets</span><span class=p>[@]</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
    <span class=k>do</span>
        <span class=nb>local</span> <span class=nv>pkgsVar</span><span class=o>=</span><span class=s2>"</span><span class=si>${</span><span class=nv>pkgAccumVarVars</span><span class=p>[hostOffset + 1]</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
        <span class=k>for</span> targetOffset in <span class=s2>"</span><span class=si>${</span><span class=nv>allPlatOffsets</span><span class=p>[@]</span><span class=si>}</span><span class=s2>"</span><span class=p>;</span>
        <span class=k>do</span>
            <span class=o>((</span> hostOffset &lt;<span class=o>=</span> targetOffset <span class=o>))</span> <span class=o>||</span> <span class=k>continue</span><span class=p>;</span>
            <span class=nb>local</span> <span class=nv>pkgsRef</span><span class=o>=</span><span class=s2>"</span><span class=si>${</span><span class=nv>pkgsVar</span><span class=si>}</span><span class=s2>[</span><span class=nv>$targetOffset</span><span class=s2> - </span><span class=nv>$hostOffset</span><span class=s2>]"</span><span class=p>;</span>
            <span class=nb>local</span> <span class=nv>pkgsSlice</span><span class=o>=</span><span class=s2>"</span><span class=si>${</span><span class=p>!pkgsRef</span><span class=si>}</span><span class=s2>[@]"</span><span class=p>;</span>
            <span class=k>for</span> pkg in <span class=si>${</span><span class=p>!pkgsSlice+</span><span class=s2>"</span><span class=si>${</span><span class=p>!pkgsSlice</span><span class=si>}</span><span class=s2>"</span><span class=si>}</span><span class=p>;</span>
            <span class=k>do</span>
                activatePackage <span class=s2>"</span><span class=nv>$pkg</span><span class=s2>"</span> <span class=s2>"</span><span class=nv>$hostOffset</span><span class=s2>"</span> <span class=s2>"</span><span class=nv>$targetOffset</span><span class=s2>"</span><span class=p>;</span>
            <span class=k>done</span><span class=p>;</span>
        <span class=k>done</span><span class=p>;</span>
    <span class=k>done</span>
<span class=o>}</span>

<span class=c1># ... hundreds of lines of shell functions...</span>

<span class=nv>PATH</span><span class=o>=</span><span class=s2>"</span><span class=nv>$PATH</span><span class=s2>:</span><span class=nv>$nix_saved_PATH</span><span class=s2>"</span>
<span class=nb>export</span> <span class=nv>NIX_BUILD_TOP</span><span class=o>=</span><span class=s2>"</span><span class=k>$(</span>mktemp -d -t nix-shell.XXXXXX<span class=k>)</span><span class=s2>"</span>
<span class=nb>export</span> <span class=nv>TMP</span><span class=o>=</span><span class=s2>"</span><span class=nv>$NIX_BUILD_TOP</span><span class=s2>"</span>
<span class=nb>export</span> <span class=nv>TMPDIR</span><span class=o>=</span><span class=s2>"</span><span class=nv>$NIX_BUILD_TOP</span><span class=s2>"</span>
<span class=nb>export</span> <span class=nv>TEMP</span><span class=o>=</span><span class=s2>"</span><span class=nv>$NIX_BUILD_TOP</span><span class=s2>"</span>
<span class=nb>export</span> <span class=nv>TEMPDIR</span><span class=o>=</span><span class=s2>"</span><span class=nv>$NIX_BUILD_TOP</span><span class=s2>"</span>
<span class=nb>eval</span> <span class=s2>"</span><span class=nv>$shellHook</span><span class=s2>"</span>
</code></pre></div><p>Okay. Not exactly useful.</p>
<p>All I really care about are the environment variables, in my typical usage. I don‚Äôt care about the ability to run <code>buildPhase</code> interactively. I have never actually written something that uses Nix‚Äôs build infrastructure to <em>build</em> itself. I write <code>shell.nix</code> files as a way to document my dependencies, and I invoke my normal interactive build tools from within the shell.</p>
<p>So <code>nix develop</code> does not seem like it‚Äôs useful to me.</p>
<p>Perhaps I can get <code>nix shell</code> to do what I want?</p>
<p>Returning to my original <code>shell.nix</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=k>with</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span> <span class=n>mkShellNoCC</span> <span class=p>{</span>
  <span class=n>nativeBuildInputs</span> <span class=o>=</span> <span class=p>[</span>
    <span class=n>fswatch</span>
    <span class=n>hugo</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>autoprefixer</span>
    <span class=n>nodePackages</span><span class=o>.</span><span class=n>postcss-cli</span>
  <span class=p>];</span>
<span class=p>}</span>
</code></pre></div><p>I can run <code>nix shell</code> with all of these at the command line and, you know, it works:</p>
<pre tabindex=0><code>nix shell 'nixpkgs#fswatch' 'nixpkgs#hugo' 'nixpkgs#nodePackages.autoprefixer' 'nixpkgs#nodePackages.postcss-cli'
Ians-MBP:ianthehenry.com ian$
</code></pre><p>But it‚Äôs still bash. I can manually invoke <code>zsh</code>, though:</p>
<pre tabindex=0><code>$ nix shell 'nixpkgs#fswatch' 'nixpkgs#hugo' 'nixpkgs#nodePackages.autoprefixer' 'nixpkgs#nodePackages.postcss-cli' 'nixpkgs#zsh' -c zsh

nix-shell:shell ~/src/ianthehenry.com ‚ûú hugo version
hugo v0.90.0+extended darwin/amd64 BuildDate=unknown
</code></pre><p>Ah, a rare glimpse at my <em>actual</em> prompt. Except‚Ä¶ huh, it sets the <code>name</code> environment variable to <code>shell</code> instead of <code>nix-shell</code>, so it‚Äôs showing up in the long form <code>nix-shell:shell</code>. Although <code>nix-shell -p</code> does the same thing, apparently. I should maybe special-case that in my prompt.</p>
<p>Can I do this same thing with <code>nix develop</code>?</p>
<pre tabindex=0><code>$ nix develop -c zsh
nix-shell ~/src/ianthehenry.com ‚ûú lsof -p $$ | grep /bin/zsh
zsh     45836  ian  txt    REG    1,4  1348368 1152921500312807015 /bin/zsh
</code></pre><p>Yeah that‚Äôs sort of convoluted but macOS doesn‚Äôt have <code>/proc</code> so this is the best I can do here.</p>
<p>Note that <code>$name</code> is <code>nix-shell</code> again, which renders as just <code>nix-shell</code> instead of <code>nix-shell:nix-shell</code>. <a href=https://github.com/ianthehenry/dotfiles/blob/59f8d97f62639a120f46f4201c6ec42ef97fc137/.zshrc#L19>This is a property of my own prompt and not really interesting to anyone else.</a></p>
<p>Hmmmm. So this is starting the <code>zsh</code> on my <code>PATH</code> which is, for some reason, <code>/bin/zsh</code>. That‚Äôs not really what I want, though. I want to start <code>nixpkgs#zsh</code>.</p>
<p>The obvious thing doesn‚Äôt work‚Ä¶</p>
<pre tabindex=0><code>$ nix develop -c 'nixpkgs#zsh'
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
/tmp/nix-shell.G4K12z/nix-shell.fozDix: line 1452: exec: nixpkgs#zsh: not found
</code></pre><p>Which, whatever. But maybe I can do something weird‚Ä¶</p>
<pre tabindex=0><code>$ nix develop -c 'nix run nixpkgs#zsh'
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty
/tmp/nix-shell.pnLUvj: line 1452: exec: nix run nixpkgs#zsh: not found
</code></pre><p>Okay fair enough. But apparently‚Ä¶</p>
<pre tabindex=0><code>$ nix develop -c nix run 'nixpkgs#zsh'
warning: Git tree '/Users/ian/src/ianthehenry.com' is dirty

nix-shell ~/src/ianthehenry.com ‚ûú lsof -p $$ | grep bin/zsh
zsh     46402  ian  txt    REG    1,6   770048             6523002 /nix/store/90f8r5pc7w5bbdslxcq18hyn6rdx5vb5-zsh-5.8/bin/zsh
</code></pre><aside>
<p>You might be wondering why I don‚Äôt just <code>-c $SHELL</code>. This is because I‚Äôm actually running this from within a <code>nix-shell -p</code> session, so my <code>$SHELL</code> has been set to my <code>$NIX_BUILD_SHELL</code>, which falls back to running <code>bash</code> if it‚Äôs not invoked in exactly the right way.</p>
<p>Why am I in a <code>nix-shell -p</code>? Because that‚Äôs how I ‚Äúinstalled‚Äù Nix 2.4. I haven‚Äôt actually upgraded to it yet: I wanted to have some reason ‚Äì any reason ‚Äì to make the switch back. Because even if my channel hack makes it not <em>that</em> annoying to use, it‚Äôs still worse than 2.3. I thought <code>nix develop</code> might be that reason, but‚Ä¶</p>
</aside>
<p>Okay. That‚Äôs‚Ä¶ something, I guess. This is a <em>usable</em> <code>nix develop</code> setup. There‚Äôs no way to make this the default, as far as I can tell, but I could at least make an alias to invoke it with <code>zsh</code>.</p>
<p>In fact it‚Äôs <em>almost</em> as usable as <code>nix-shell</code>. The disadvantage is the annoying <code>flake.nix</code> boilerplate, and adding GC roots is‚Ä¶ a weird new puzzle that I don‚Äôt want to solve right now. So‚Ä¶ I dunno. It doesn‚Äôt seem like <code>flake.lock</code> is sufficiently more useful than <a href=https://github.com/ianthehenry/sd-nix/blob/f9c6f466c253f0a7aaf2aa63dc602f710811e9e6/shell>my hand-rolled pinning scheme</a> ‚Äì to me ‚Äì to justify the boilerplate. And I‚Äôm sure third-party tools like <a href=https://github.com/nmattia/niv><code>niv</code></a> work even better.</p>
<p>Which means that, once again, the only reason to use flakes is because <code>nix search</code> forces me to.</p>
<p>Perhaps the correct next move is to fork Nix 2.4 and add a <code>nix-search</code> binary that searches through my channel again, and pretend like this whole flakes thing was just a bad dream.</p>
<hr>
<ul>
<li>How can I suppress all the ‚Äú<code>warning: Git tree '...' is dirty</code>‚Äù messages?</li>
<li>How am I supposed to use <code>nix develop --profile</code>?</li>
<li>What‚Äôs up with that <code>nix develop --redirect</code> thing?</li>
</ul></div>
</article>
<div class=post-footer>
<a href="mailto:ianthehenry@gmail.com?subject=let%27s%20talk%20about%20%22New%20and%20unimproved%20shells%22&amp;body=First%20of%20all,%20I%20just%20wanted%20to%20say%20that%20I%20forgive%20you%20for%20not%20having%20a%20real%20comment%20system%20on%20your%20site.">comment on this post</a><a href=https://twitter.com/ianthehenry/status/1475612368226955269>comment via twitter</a></div>
<aside class=series-rider>
<p>
This post is part of the series <a class=series-name href=https://ianthehenry.com/posts/how-to-learn-nix/>How to Learn Nix</a>.
You can
<a target=_blank href=https://ianthehenry.com/feed.xml>subscribe to my RSS feed</a>
or
<a target=_blank href=https://twitter.com/ianthehenry>follow me on Twitter</a>
for more, or <a href=https://ianthehenry.com/posts/>peruse my back catalog</a> if you're in the mood for something different.
<div class=subsection-header>Opening remarks</div><ol start=1 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/introduction/>What's all this about?</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/prior-knowledge/>Prior knowledge</a></li>
</ol><div class=subsection-header>Reading the Nix manual</div><ol start=3 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/glossary/>What we talk about when we talk about Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/quick-start-guide/>Quick starts, full hearts</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/basic-package-management/>Basic package management</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/profiles/>Profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/garbage-collection/>Garbage collection</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/channels/>Channels</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/sharing/>Learning to share</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-derivation/>My first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/okay-my-actual-first-derivation/>Okay my actual first derivation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-language/>The Nix expression language</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations/>Derivations</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/built-in-functions/>Built-in Functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/advanced-topics/>Advanced Topics</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/command-reference/>Command Reference</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/configuration/>Configuration</a></li>
</ol><div class=subsection-header>Interlude: in which we follow our hearts, however briefly</div><ol start=18 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-manual-reflection/>So I read the manual huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/>Switching from Homebrew to Nix</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-nix-bug/>My first Nix bug</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/my-first-package-upgrade/>My first package upgrade</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/declarative-user-environment/>Setting up a declarative user environment</a></li>
</ol><div class=subsection-header>Reading the Nixpkgs manual</div><ol start=23 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-learn-nixpkgs/>How to learn Nixpkgs</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overlays/>Overlays</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/overriding/>Overriding</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/an-infinite-list-of-functions/>An infinite list of functions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/even-more-functions-somehow/>Even more functions, somehow</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/the-standard-environment/>The standard environment</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/derivations-in-detail/>Derivations in detail</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/cross-compilation/>Cross-compilation</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/platform-notes/>Platform notes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/builders/>Builders</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/languages-and-frameworks/>Languages and frameworks</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/random-package-grab-bag/>Random package grab-bag</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/how-to-give-back/>How to give back</a></li>
</ol><div class=subsection-header>Documentation behind us, we set out on our own</div><ol start=36 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nixpkgs-reflection/>So I read the other manual, huh</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/saving-your-shell/>Saving your shell</a></li>
</ol><div class=subsection-header>Oh right forgot about Nix Pills</div><ol start=38 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-pills/>Nix Pills</a></li>
</ol><div class=subsection-header>Our whole lives ahead of us</div><ol start=39 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/python3-alpha/>How to install Python</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/open-questions/>Open questions</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/ambiguous-packages/>Ambiguous packages</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-zshell/>Running zsh in nix-shell</a></li>
</ol><div class=subsection-header>Nix 2.4 slithers to life</div><ol start=43 class=post-list><li><a href=https://ianthehenry.com/posts/how-to-learn-nix/flakes/>My first brush with flakes</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/more-flakes/>More flakes, unfortunately</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/new-profiles/>Fancy new profiles</a></li>
<li><a href=https://ianthehenry.com/posts/how-to-learn-nix/chipping-away-at-flakes/>Chipping away at flakes</a></li>
<li><strong><a href=https://ianthehenry.com/posts/how-to-learn-nix/nix-develop/>New and unimproved shells</a></strong>&nbsp;‚Üê&nbsp;you are here</li>
</ol>
</aside>
</main>
<footer>
¬© 1899-1907 <a href=https://ianthehenry.com/about/>Ian Henry</a>
</footer>
